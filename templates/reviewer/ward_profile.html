{% extends 'admin_base.html' %}
{% load humanize %}

{% block title %}Ward Profile - {{ assigned_ward.name }} - Reviewer Panel{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb a:hover {
        color: #2980b9;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #F1F5F9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .page-title {
        font-size: 22px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-subtitle {
        color: #64748B;
        font-size: 14px;
        margin: 0;
    }

    .export-btn {
        padding: 10px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .export-btn:hover {
        background: #2980b9;
        transform: translateY(-1px);
        color: white;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: currentColor;
        opacity: 0.3;
    }

    .stat-card.stat-primary { color: #3498db; }
    .stat-card.stat-warning { color: #f39c12; }
    .stat-card.stat-info { color: #16a085; }
    .stat-card.stat-success { color: #27ae60; }
    .stat-card.stat-danger { color: #e74c3c; }
    .stat-card.stat-secondary { color: #95a5a6; }

    .stat-icon {
        font-size: 24px;
        opacity: 0.2;
        position: absolute;
        right: 15px;
        top: 15px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 13px;
        color: #64748B;
        font-weight: 500;
    }

    /* Ward Profile Specific Styles */
    .ward-layout {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (max-width: 992px) {
        .ward-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Info Cards for left column */
    .info-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .info-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .info-card-header {
        background: #F8FAFC;
        padding: 16px 20px;
        border-bottom: 1px solid #E2E8F0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .info-card-header i {
        font-size: 20px;
        color: #3498db;
    }

    .info-card-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin: 0;
    }

    .info-card-body {
        padding: 20px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 8px 0;
        border-bottom: 1px solid #F1F5F9;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-size: 13px;
        font-weight: 500;
        color: #64748B;
        flex: 1;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
        color: #334155;
        flex: 1;
        text-align: right;
    }

    .info-value a {
        color: #3498db;
        text-decoration: none;
    }

    .info-value a:hover {
        text-decoration: underline;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 4px;
    }

    .badge-success {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-secondary {
        background: #F1F5F9;
        color: #64748B;
    }

    /* Tabs for right column */
    .tabs-container {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        background: #F8FAFC;
        border-bottom: 1px solid #E2E8F0;
        overflow-x: auto;
    }

    .tab-btn {
        padding: 16px 24px;
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #64748B;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        background: rgba(52, 152, 219, 0.05);
        color: #3498db;
    }

    .tab-btn.active {
        color: #3498db;
        border-bottom-color: #3498db;
        background: white;
    }

    .tab-content {
        display: none;
        padding: 24px;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Allocation Section */
    .allocation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .allocation-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .allocation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .allocation-icon {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .allocation-primary {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .allocation-success {
        background: #D1FAE5;
        color: #065F46;
    }

    .allocation-info {
        background: #E0E7FF;
        color: #3730A3;
    }

    .allocation-warning {
        background: #FEF3C7;
        color: #92400E;
    }

    .allocation-details {
        flex: 1;
    }

    .allocation-value {
        font-size: 20px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 4px;
    }

    .allocation-label {
        font-size: 13px;
        color: #64748B;
        font-weight: 500;
    }

    /* Progress Section */
    .progress-section {
        background: #F8FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        margin-top: 16px;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .progress-label {
        font-size: 14px;
        font-weight: 600;
        color: #1E293B;
    }

    .progress-percentage {
        font-size: 16px;
        font-weight: 700;
        color: #3498db;
    }

    .progress-bar-container {
        height: 8px;
        background: #E2E8F0;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* Locations Grid */
    .locations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .location-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .location-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .location-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #F1F5F9;
    }

    .location-header i {
        font-size: 20px;
        color: #3498db;
    }

    .location-header h4 {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin: 0;
    }

    .location-body {
        font-size: 14px;
        color: #64748B;
    }

    .location-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .location-info i {
        font-size: 14px;
        color: #94A3B8;
    }

    /* Description Section */
    .description-content {
        background: #F8FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        font-size: 14px;
        line-height: 1.6;
        color: #334155;
        margin-top: 16px;
    }

    /* Actions Grid */
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }

    .action-link-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 24px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        display: block;
    }

    .action-link-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        border-color: #3498db;
        color: inherit;
    }

    .action-icon {
        width: 48px;
        height: 48px;
        background: #DBEAFE;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #3498db;
        margin-bottom: 16px;
    }

    .action-link-card h4 {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
    }

    .action-link-card p {
        font-size: 13px;
        color: #64748B;
        margin: 0;
        line-height: 1.5;
    }

    /* Section Titles */
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i {
        color: #3498db;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-dialog {
        background: white;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #F1F5F9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #64748B;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #F1F5F9;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .ward-layout {
            grid-template-columns: 1fr;
        }
        
        .tabs-header {
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .allocation-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .locations-grid {
            grid-template-columns: 1fr;
        }
        
        .actions-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        .allocation-grid {
            grid-template-columns: 1fr;
        }
        
        .tab-btn {
            min-width: 100px;
            font-size: 13px;
            padding: 12px 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'reviewer_dashboard' %}">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Ward Profile</li>
        </ol>
    </nav>

    <div class="section-container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-map-marked-alt"></i>
                    {{ assigned_ward.name }} Ward
                </h1>
                <p class="page-subtitle">
                    Constituency: {{ assigned_ward.constituency.name }}
                </p>
            </div>
            <a href="{% url 'ward_statistics' %}" class="export-btn">
                <i class="bi bi-bar-chart"></i>
                View Statistics
            </a>
        </div>

        <!-- 4x8 Layout with Info Cards on left (4) and Tabs on right (8) -->
        <div class="ward-layout">
            <!-- Left Column: Information Cards (4 items) -->
            <div class="left-column">
                <!-- Basic Information Card -->
                <div class="info-card">
                    <div class="info-card-header">
                        <i class="bi bi-info-circle"></i>
                        <h3>Basic Information</h3>
                    </div>
                    <div class="info-card-body">
                        <div class="info-row">
                            <span class="info-label">Ward Name:</span>
                            <span class="info-value">{{ assigned_ward.name }} Ward</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ward Code:</span>
                            <span class="info-value">{{ assigned_ward.code|default:"N/A" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Constituency:</span>
                            <span class="info-value">{{ assigned_ward.constituency.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">County:</span>
                            <span class="info-value">{{ assigned_ward.constituency.county.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Population:</span>
                            <span class="info-value">{{ assigned_ward.population|intcomma|default:"N/A" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                {% if assigned_ward.is_active %}
                                    <span class="badge badge-success">Active</span>
                                {% else %}
                                    <span class="badge badge-secondary">Inactive</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Ward Representative Card -->
                <div class="info-card">
                    <div class="info-card-header">
                        <i class="bi bi-person-badge"></i>
                        <h3>Ward Representative (MCA)</h3>
                    </div>
                    <div class="info-card-body">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">{{ ward_rep.name|default:"N/A" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Political Party:</span>
                            <span class="info-value">{{ ward_rep.party|default:"N/A" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">
                                {% if ward_rep.phone %}
                                    <a href="tel:{{ ward_rep.phone }}">{{ ward_rep.phone }}</a>
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">
                                {% if ward_rep.email %}
                                    <a href="mailto:{{ ward_rep.email }}">{{ ward_rep.email }}</a>
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                        {% if assigned_ward.ward_office_location %}
                        <div class="info-row">
                            <span class="info-label">Office Location:</span>
                            <span class="info-value">{{ assigned_ward.ward_office_location }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="info-card">
                    <div class="info-card-header">
                        <i class="bi bi-speedometer2"></i>
                        <h3>Quick Statistics</h3>
                    </div>
                    <div class="info-card-body">
                        <div class="info-row">
                            <span class="info-label">Registered Applicants:</span>
                            <span class="info-value">{{ total_residents|intcomma }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Applications:</span>
                            <span class="info-value">{{ total_applications|intcomma }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Current FY Applications:</span>
                            <span class="info-value">{{ current_fy_applications|intcomma }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Approval Rate:</span>
                            <span class="info-value">
                                {% if total_applications > 0 %}
                                    {% widthratio approved_applications total_applications 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Review Status -->
                <div class="info-card">
                    <div class="info-card-header">
                        <i class="bi bi-clipboard-check"></i>
                        <h3>My Review Status</h3>
                    </div>
                    <div class="info-card-body">
                        <div class="info-row">
                            <span class="info-label">Pending Reviews:</span>
                            <span class="info-value">{{ pending_reviews|intcomma|default:"0" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Reviews Completed:</span>
                            <span class="info-value">{{ completed_reviews|intcomma|default:"0" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Average Score Given:</span>
                            <span class="info-value">{{ average_score|floatformat:1|default:"0.0" }}/10</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Review Completion:</span>
                            <span class="info-value">
                                {% if pending_reviews|add:completed_reviews > 0 %}
                                    {% widthratio completed_reviews pending_reviews|add:completed_reviews 100 %}%
                                {% else %}
                                    0%
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Tabs Content (8 tabs) -->
            <div class="right-column">
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="allocation">
                            <i class="bi bi-cash-coin"></i>
                            Allocation
                        </button>
                        <button class="tab-btn" data-tab="applications">
                            <i class="bi bi-file-earmark-text"></i>
                            Applications
                        </button>
                        <button class="tab-btn" data-tab="locations">
                            <i class="bi bi-geo-alt"></i>
                            Locations
                        </button>
                        <button class="tab-btn" data-tab="performance">
                            <i class="bi bi-graph-up"></i>
                            Performance
                        </button>
                        <button class="tab-btn" data-tab="demographics">
                            <i class="bi bi-people"></i>
                            Demographics
                        </button>
                        <button class="tab-btn" data-tab="institutions">
                            <i class="bi bi-building"></i>
                            Institutions
                        </button>
                        <button class="tab-btn" data-tab="categories">
                            <i class="bi bi-tag"></i>
                            Categories
                        </button>
                        <button class="tab-btn" data-tab="trends">
                            <i class="bi bi-clock-history"></i>
                            Trends
                        </button>
                    </div>

                    <!-- Allocation Tab -->
                    <div class="tab-content active" id="allocation-tab">
                        <h3 class="section-title">
                            <i class="bi bi-cash-coin"></i>
                            Current Fiscal Year Allocation ({{ current_fiscal_year.name }})
                        </h3>
                        
                        {% if current_fiscal_year and ward_allocation %}
                        <div class="allocation-grid">
                            <div class="allocation-card">
                                <div class="allocation-icon allocation-primary">
                                    <i class="bi bi-wallet2"></i>
                                </div>
                                <div class="allocation-details">
                                    <div class="allocation-value">
                                        KSh {{ ward_allocation.allocated_amount|floatformat:0|intcomma }}
                                    </div>
                                    <div class="allocation-label">Total Allocated</div>
                                </div>
                            </div>

                            <div class="allocation-card">
                                <div class="allocation-icon allocation-success">
                                    <i class="bi bi-arrow-down-circle"></i>
                                </div>
                                <div class="allocation-details">
                                    <div class="allocation-value">
                                        KSh {{ ward_allocation.spent_amount|floatformat:0|intcomma }}
                                    </div>
                                    <div class="allocation-label">Amount Disbursed</div>
                                </div>
                            </div>

                            <div class="allocation-card">
                                <div class="allocation-icon allocation-info">
                                    <i class="bi bi-piggy-bank"></i>
                                </div>
                                <div class="allocation-details">
                                    <div class="allocation-value">
                                        KSh {{ ward_allocation.balance|floatformat:0|intcomma }}
                                    </div>
                                    <div class="allocation-label">Balance Remaining</div>
                                </div>
                            </div>

                            <div class="allocation-card">
                                <div class="allocation-icon allocation-warning">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="allocation-details">
                                    <div class="allocation-value">
                                        {{ ward_allocation.beneficiaries_count|intcomma }}
                                    </div>
                                    <div class="allocation-label">Beneficiaries</div>
                                </div>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-header">
                                <span class="progress-label">Utilization Rate</span>
                                <span class="progress-percentage">
                                    {% widthratio ward_allocation.spent_amount ward_allocation.allocated_amount 100 %}%
                                </span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: {% widthratio ward_allocation.spent_amount ward_allocation.allocated_amount 100 %}%">
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-wallet2"></i>
                            </div>
                            <h3 class="empty-title">No Allocation Data</h3>
                            <p class="empty-text">
                                No allocation data available for the current fiscal year.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Applications Tab -->
                    <div class="tab-content" id="applications-tab">
                        <h3 class="section-title">
                            <i class="bi bi-file-earmark-text"></i>
                            Application Statistics
                        </h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-value">{{ total_residents|intcomma }}</div>
                                <div class="stat-label">Registered Applicants</div>
                            </div>

                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <div class="stat-value">{{ total_applications|intcomma }}</div>
                                <div class="stat-label">Total Applications (All Time)</div>
                            </div>

                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="stat-value">{{ current_fy_applications|intcomma }}</div>
                                <div class="stat-label">Current FY Applications</div>
                            </div>

                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="bi bi-clock-history"></i>
                                </div>
                                <div class="stat-value">{{ pending_applications|intcomma|default:"0" }}</div>
                                <div class="stat-label">Pending Review</div>
                            </div>
                        </div>

                        {% if application_status_chart %}
                        <div class="description-content mt-4">
                            <h4>Application Status Distribution</h4>
                            <p>{{ application_status_chart|safe }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Locations Tab -->
                    <div class="tab-content" id="locations-tab">
                        <h3 class="section-title">
                            <i class="bi bi-geo-alt"></i>
                            Locations in {{ assigned_ward.name }} Ward
                        </h3>
                        
                        {% if locations %}
                        <div class="locations-grid">
                            {% for location in locations %}
                            <div class="location-card">
                                <div class="location-header">
                                    <i class="bi bi-pin-map"></i>
                                    <h4>{{ location.name }}</h4>
                                </div>
                                <div class="location-body">
                                    {% if location.population %}
                                    <div class="location-info">
                                        <i class="bi bi-people"></i>
                                        <span>Population: {{ location.population|intcomma }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="location-info">
                                        <i class="bi bi-building"></i>
                                        <span>{{ location.sublocations.count }} Sub-location(s)</span>
                                    </div>
                                    {% if location.applications_count %}
                                    <div class="location-info">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <span>{{ location.applications_count }} Application(s)</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-geo-alt"></i>
                            </div>
                            <h3 class="empty-title">No Location Data</h3>
                            <p class="empty-text">
                                No location data available for this ward.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Performance Tab -->
                    <div class="tab-content" id="performance-tab">
                        <h3 class="section-title">
                            <i class="bi bi-graph-up"></i>
                            Ward Performance Metrics
                        </h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="stat-value">{{ approval_rate|floatformat:1 }}%</div>
                                <div class="stat-label">Approval Rate</div>
                            </div>

                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="bi bi-arrow-up-circle"></i>
                                </div>
                                <div class="stat-value">{{ avg_processing_time|default:"N/A" }}</div>
                                <div class="stat-label">Avg Processing Time</div>
                            </div>

                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="bi bi-currency-exchange"></i>
                                </div>
                                <div class="stat-value">{{ utilization_rate|floatformat:1 }}%</div>
                                <div class="stat-label">Funds Utilization</div>
                            </div>

                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="bi bi-person-check"></i>
                                </div>
                                <div class="stat-value">{{ satisfaction_score|floatformat:1 }}/10</div>
                                <div class="stat-label">Satisfaction Score</div>
                            </div>
                        </div>

                        {% if performance_metrics %}
                        <div class="description-content mt-4">
                            <h4>Performance Overview</h4>
                            <p>{{ performance_metrics.description|default:"No detailed performance metrics available." }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Demographics Tab -->
                    <div class="tab-content" id="demographics-tab">
                        <h3 class="section-title">
                            <i class="bi bi-people"></i>
                            Demographic Information
                        </h3>
                        
                        {% if demographics %}
                        <div class="stats-grid">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="bi bi-gender-male"></i>
                                </div>
                                <div class="stat-value">{{ demographics.male_percentage|floatformat:1 }}%</div>
                                <div class="stat-label">Male Applicants</div>
                            </div>

                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="bi bi-gender-female"></i>
                                </div>
                                <div class="stat-value">{{ demographics.female_percentage|floatformat:1 }}%</div>
                                <div class="stat-label">Female Applicants</div>
                            </div>

                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="stat-value">{{ demographics.avg_age|floatformat:1 }}</div>
                                <div class="stat-label">Average Age</div>
                            </div>

                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="bi bi-house"></i>
                                </div>
                                <div class="stat-value">{{ demographics.household_size|floatformat:1 }}</div>
                                <div class="stat-label">Avg Household Size</div>
                            </div>
                        </div>

                        <div class="description-content mt-4">
                            <h4>Demographic Breakdown</h4>
                            <p>{{ demographics.description|default:"No detailed demographic information available." }}</p>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <h3 class="empty-title">No Demographic Data</h3>
                            <p class="empty-text">
                                No demographic data available for this ward.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Institutions Tab -->
                    <div class="tab-content" id="institutions-tab">
                        <h3 class="section-title">
                            <i class="bi bi-building"></i>
                            Educational Institutions
                        </h3>
                        
                        {% if institutions %}
                        <div class="locations-grid">
                            {% for institution in institutions|slice:":6" %}
                            <div class="location-card">
                                <div class="location-header">
                                    <i class="bi bi-building"></i>
                                    <h4>{{ institution.name }}</h4>
                                </div>
                                <div class="location-body">
                                    <div class="location-info">
                                        <i class="bi bi-tag"></i>
                                        <span>{{ institution.get_institution_type_display }}</span>
                                    </div>
                                    {% if institution.county %}
                                    <div class="location-info">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>{{ institution.county }}</span>
                                    </div>
                                    {% endif %}
                                    {% if institution.student_count %}
                                    <div class="location-info">
                                        <i class="bi bi-people"></i>
                                        <span>{{ institution.student_count }} Students</span>
                                    </div>
                                    {% endif %}
                                    {% if institution.applications_count %}
                                    <div class="location-info">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <span>{{ institution.applications_count }} Application(s)</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if institutions|length > 6 %}
                        <div class="text-center mt-4">
                            <a href="#" class="clear-btn">
                                <i class="bi bi-eye"></i> View All {{ institutions|length }} Institutions
                            </a>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <h3 class="empty-title">No Institution Data</h3>
                            <p class="empty-text">
                                No educational institution data available for this ward.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Categories Tab -->
                    <div class="tab-content" id="categories-tab">
                        <h3 class="section-title">
                            <i class="bi bi-tag"></i>
                            Bursary Categories
                        </h3>
                        
                        {% if categories %}
                        <div class="locations-grid">
                            {% for category in categories|slice:":6" %}
                            <div class="location-card">
                                <div class="location-header">
                                    <i class="bi bi-tag"></i>
                                    <h4>{{ category.name }}</h4>
                                </div>
                                <div class="location-body">
                                    {% if category.max_amount_per_applicant %}
                                    <div class="location-info">
                                        <i class="bi bi-cash"></i>
                                        <span>Max: KSh {{ category.max_amount_per_applicant|intcomma }}</span>
                                    </div>
                                    {% endif %}
                                    {% if category.applications_count %}
                                    <div class="location-info">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <span>{{ category.applications_count }} Application(s)</span>
                                    </div>
                                    {% endif %}
                                    {% if category.total_amount_requested %}
                                    <div class="location-info">
                                        <i class="bi bi-currency-exchange"></i>
                                        <span>Total: KSh {{ category.total_amount_requested|intcomma }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="location-info">
                                        <i class="bi bi-check-circle"></i>
                                        <span>
                                            {% if category.is_active %}
                                            <span class="badge badge-success">Active</span>
                                            {% else %}
                                            <span class="badge badge-secondary">Inactive</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-tag"></i>
                            </div>
                            <h3 class="empty-title">No Category Data</h3>
                            <p class="empty-text">
                                No bursary category data available for this ward.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Trends Tab -->
                    <div class="tab-content" id="trends-tab">
                        <h3 class="section-title">
                            <i class="bi bi-clock-history"></i>
                            Application Trends
                        </h3>
                        
                        {% if trends %}
                        <div class="stats-grid">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="bi bi-arrow-up-right"></i>
                                </div>
                                <div class="stat-value">{{ trends.monthly_growth|floatformat:1 }}%</div>
                                <div class="stat-label">Monthly Growth</div>
                            </div>

                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <div class="stat-value">{{ trends.peak_month|default:"N/A" }}</div>
                                <div class="stat-label">Peak Application Month</div>
                            </div>

                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                                <div class="stat-value">{{ trends.year_over_year|floatformat:1 }}%</div>
                                <div class="stat-label">YoY Growth</div>
                            </div>

                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="stat-value">{{ trends.avg_processing_days|default:"N/A" }} days</div>
                                <div class="stat-label">Avg Processing Time</div>
                            </div>
                        </div>

                        {% if trends.description %}
                        <div class="description-content mt-4">
                            <h4>Trend Analysis</h4>
                            <p>{{ trends.description }}</p>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <h3 class="empty-title">No Trend Data</h3>
                            <p class="empty-text">
                                No trend data available for this ward.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Ward Information -->
        {% if assigned_ward.description %}
        <div class="description-section">
            <h2 class="section-title">
                <i class="bi bi-file-text"></i>
                Ward Description
            </h2>
            <div class="description-content">
                {{ assigned_ward.description|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="actions-section">
            <h2 class="section-title">
                <i class="bi bi-lightning"></i>
                Quick Actions
            </h2>
            
            <div class="actions-grid">
                <a href="{% url 'pending_applications' %}" class="action-link-card">
                    <div class="action-icon">
                        <i class="bi bi-clipboard-check"></i>
                    </div>
                    <h4>Review Applications</h4>
                    <p>Review pending applications from your ward</p>
                </a>

                <a href="{% url 'ward_statistics' %}" class="action-link-card">
                    <div class="action-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h4>View Statistics</h4>
                    <p>Detailed analytics and trends</p>
                </a>

                <a href="{% url 'ward_allocations' %}" class="action-link-card">
                    <div class="action-icon">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <h4>Budget Allocations</h4>
                    <p>View all fiscal year allocations</p>
                </a>

                <a href="{% url 'applicant_search' %}" class="action-link-card">
                    <div class="action-icon">
                        <i class="bi bi-search"></i>
                    </div>
                    <h4>Search Applications</h4>
                    <p>Find specific applications or applicants</p>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal" id="exportModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-download"></i>
                    Export Ward Data
                </h5>
                <button type="button" class="btn-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="post" id="exportForm">
                    {% csrf_token %}
                    <div class="filter-group">
                        <label class="filter-label" for="export_format">
                            <i class="bi bi-file-earmark"></i> Export Format
                        </label>
                        <select class="filter-select" name="format" id="export_format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                    <div class="filter-group mt-3">
                        <label class="filter-label" for="export_data">
                            <i class="bi bi-database"></i> Data to Export
                        </label>
                        <select class="filter-select" name="data_type" id="export_data">
                            <option value="ward_info">Ward Information</option>
                            <option value="applications">Applications Data</option>
                            <option value="allocations">Allocation Data</option>
                            <option value="statistics">Statistics Report</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="clear-btn" onclick="closeModal()">Cancel</button>
                <button type="submit" form="exportForm" class="filter-btn">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tab buttons
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`${tabId}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Set active tab button
            const activeButton = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // Add click event listeners to tab buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                switchTab(tabId);
            });
        });

        // Initialize with first tab active (already set in HTML)
        switchTab('allocation');

        // Progress bar animation on tab switch
        const allocationTab = document.getElementById('allocation-tab');
        if (allocationTab && allocationTab.classList.contains('active')) {
            animateProgressBars();
        }

        // Add observer to animate progress bars when allocation tab becomes visible
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.target.id === 'allocation-tab') {
                    animateProgressBars();
                }
            });
        }, { threshold: 0.1 });

        const allocationTabContent = document.getElementById('allocation-tab');
        if (allocationTabContent) {
            observer.observe(allocationTabContent);
        }
    });

    function animateProgressBars() {
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }

    // Modal functions
    function closeModal() {
        document.getElementById('exportModal').classList.remove('show');
    }

    // Open modal on button click
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-bs-toggle="modal"]')) {
            e.preventDefault();
            const targetModal = e.target.closest('[data-bs-toggle="modal"]').getAttribute('data-bs-target');
            document.querySelector(targetModal).classList.add('show');
        }
    });

    // Close modal on background click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
        }
    });
</script>
{% endblock %}