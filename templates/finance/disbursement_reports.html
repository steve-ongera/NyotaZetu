{% extends 'admin_base.html' %}
{% load humanize %}

{% block title %}Disbursement Reports - {{ fiscal_year.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Breadcrumbs */
    .breadcrumb-custom {
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        border: 1px solid #E2E8F0;
    }

    .breadcrumb-custom a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb-custom a:hover {
        color: #2980b9;
    }

    .breadcrumb-custom .separator {
        color: #94A3B8;
        margin: 0 4px;
    }

    .breadcrumb-custom .current {
        color: #1E293B;
        font-weight: 600;
    }

    /* Page Header */
    .page-header {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1E293B;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-title i {
        color: #3498db;
    }

    .page-subtitle {
        color: #64748B;
        font-size: 14px;
        margin: 0;
    }

    /* Filter Section */
    .filter-section {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .filter-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group label {
        font-size: 13px;
        font-weight: 500;
        color: #475569;
    }

    .form-control {
        padding: 10px 12px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F8FAFC;
    }

    .btn-success {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Statistics Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 1px solid #E2E8F0;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .stat-icon.blue {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
    }

    .stat-icon.green {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        color: white;
    }

    .stat-icon.purple {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        color: white;
    }

    .stat-icon.yellow {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        color: white;
    }

    .stat-icon.red {
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1E293B;
        margin-bottom: 4px;
        line-height: 1;
    }

    .stat-label {
        color: #64748B;
        font-size: 14px;
        font-weight: 500;
    }

    .stat-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        background: rgba(16, 185, 129, 0.1);
        color: #10B981;
    }

    /* Content Cards */
    .content-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        border: 1px solid #E2E8F0;
        margin-bottom: 24px;
    }

    .card-header-custom {
        padding: 20px 24px;
        border-bottom: 1px solid #E2E8F0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
    }

    .card-title i {
        color: #3498db;
    }

    /* Chart Container */
    .chart-container {
        position: relative;
        padding: 24px;
        min-height: 300px;
    }

    .chart-container canvas {
        max-height: 400px;
    }

    /* Tables */
    .table-custom {
        width: 100%;
        margin: 0;
    }

    .table-custom thead th {
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748B;
        border-bottom: 2px solid #E2E8F0;
        padding: 16px 24px;
        background: #F8FAFC;
    }

    .table-custom tbody td {
        padding: 16px 24px;
        vertical-align: middle;
        border-bottom: 1px solid #F1F5F9;
        color: #1E293B;
        font-size: 14px;
    }

    .table-custom tbody tr:hover {
        background-color: #F8FAFC;
    }

    /* Grid Layouts */
    .grid-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    .grid-layout-thirds {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }

    /* Progress Bar */
    .progress-bar-custom {
        height: 8px;
        background: #F1F5F9;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db 0%, #10B981 100%);
        border-radius: 8px;
        transition: width 0.3s ease;
    }

    /* Export Button */
    .export-dropdown {
        position: relative;
        display: inline-block;
    }

    .export-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 8px;
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        min-width: 160px;
        z-index: 1000;
    }

    .export-menu.show {
        display: block;
    }

    .export-menu a {
        display: block;
        padding: 10px 16px;
        color: #1E293B;
        text-decoration: none;
        font-size: 14px;
        transition: background 0.2s;
    }

    .export-menu a:hover {
        background: #F8FAFC;
    }

    .export-menu a i {
        margin-right: 8px;
        color: #64748B;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .grid-layout, .grid-layout-thirds {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js default configuration
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#64748B';
    
    // 1. Institution Type Distribution (Pie Chart)
    const institutionTypeData = {{ institution_type_chart|safe }};
    if (document.getElementById('institutionTypeChart')) {
        new Chart(document.getElementById('institutionTypeChart'), {
            type: 'pie',
            data: {
                labels: institutionTypeData.labels,
                datasets: [{
                    data: institutionTypeData.data,
                    backgroundColor: institutionTypeData.colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'KES ' + context.parsed.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 2. Ward Distribution (Bar Chart)
    const wardData = {{ ward_distribution_chart|safe }};
    if (document.getElementById('wardDistributionChart')) {
        new Chart(document.getElementById('wardDistributionChart'), {
            type: 'bar',
            data: {
                labels: wardData.labels,
                datasets: [{
                    label: 'Disbursed Amount',
                    data: wardData.amounts,
                    backgroundColor: '#3498db',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { 
                        grid: { display: false },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }
    
    // 3. Monthly Trend (Line Chart)
    const monthlyData = {{ monthly_trend_chart|safe }};
    if (document.getElementById('monthlyTrendChart')) {
        new Chart(document.getElementById('monthlyTrendChart'), {
            type: 'line',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'Monthly Disbursements',
                    data: monthlyData.amounts,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 4. Payment Method Distribution (Donut Chart)
    const paymentData = {{ payment_method_chart|safe }};
    if (document.getElementById('paymentMethodChart')) {
        new Chart(document.getElementById('paymentMethodChart'), {
            type: 'doughnut',
            data: {
                labels: paymentData.labels,
                datasets: [{
                    data: paymentData.data,
                    backgroundColor: paymentData.colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'KES ' + context.parsed.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 5. Gender Distribution (Donut Chart)
    const genderData = {{ gender_distribution_chart|safe }};
    if (document.getElementById('genderDistributionChart')) {
        new Chart(document.getElementById('genderDistributionChart'), {
            type: 'doughnut',
            data: {
                labels: genderData.labels,
                datasets: [{
                    data: genderData.data,
                    backgroundColor: genderData.colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'KES ' + context.parsed.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // 6. Category Distribution (Horizontal Bar Chart)
    const categoryData = {{ category_distribution_chart|safe }};
    if (document.getElementById('categoryDistributionChart')) {
        new Chart(document.getElementById('categoryDistributionChart'), {
            type: 'bar',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    label: 'Disbursed Amount',
                    data: categoryData.data,
                    backgroundColor: '#8B5CF6',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.x.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    y: { grid: { display: false } }
                }
            }
        });
    }
    
    // 7. Top Institutions (Horizontal Bar Chart)
    const topInstitutionsData = {{ top_institutions_chart|safe }};
    if (document.getElementById('topInstitutionsChart')) {
        new Chart(document.getElementById('topInstitutionsChart'), {
            type: 'bar',
            data: {
                labels: topInstitutionsData.labels,
                datasets: [{
                    label: 'Disbursed Amount',
                    data: topInstitutionsData.data,
                    backgroundColor: '#F59E0B',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.x.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    y: { grid: { display: false } }
                }
            }
        });
    }
    
    // 8. Weekly Trend (Area Chart)
    const weeklyData = {{ weekly_trend_chart|safe }};
    if (document.getElementById('weeklyTrendChart')) {
        new Chart(document.getElementById('weeklyTrendChart'), {
            type: 'line',
            data: {
                labels: weeklyData.labels,
                datasets: [{
                    label: 'Weekly Disbursements',
                    data: weeklyData.data,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'KES ' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#F1F5F9' },
                        ticks: {
                            callback: function(value) {
                                return 'KES ' + value.toLocaleString();
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    // 9. Constituency Distribution (Pie Chart)
    const constituencyData = {{ constituency_distribution_chart|safe }};
    if (document.getElementById('constituencyDistributionChart')) {
        new Chart(document.getElementById('constituencyDistributionChart'), {
            type: 'pie',
            data: {
                labels: constituencyData.labels,
                datasets: [{
                    data: constituencyData.data,
                    backgroundColor: ['#3498db', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'KES ' + context.parsed.toLocaleString();
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Export dropdown toggle
    const exportBtn = document.getElementById('exportBtn');
    const exportMenu = document.getElementById('exportMenu');
    
    if (exportBtn && exportMenu) {
        exportBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            exportMenu.classList.toggle('show');
        });
        
        document.addEventListener('click', function() {
            exportMenu.classList.remove('show');
        });
    }
});
</script>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<nav class="breadcrumb-custom">
    <a href="{% url 'finance_dashboard' %}">
        <i class="bi bi-house-door"></i> Finance Dashboard
    </a>
    <span class="separator">/</span>
    <a href="#">Reports</a>
    <span class="separator">/</span>
    <span class="current">Disbursement Reports</span>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
            <h1 class="page-title">
                <i class="bi bi-graph-up-arrow"></i>
                Disbursement Reports
            </h1>
            <p class="page-subtitle">
                Comprehensive disbursement analytics and insights for {{ fiscal_year.name }}
            </p>
        </div>
        <div class="export-dropdown">
            <button class="btn btn-success" id="exportBtn">
                <i class="bi bi-download"></i>
                Export Report
                <i class="bi bi-chevron-down" style="font-size: 12px;"></i>
            </button>
            <div class="export-menu" id="exportMenu">
                <a href="#">
                    <i class="bi bi-file-pdf"></i> Export as PDF
                </a>
                <a href="#">
                    <i class="bi bi-file-excel"></i> Export as Excel
                </a>
                <a href="#">
                    <i class="bi bi-file-spreadsheet"></i> Export as CSV
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters Section -->
<div class="filter-section">
    <div class="filter-header">
        <h6 class="filter-title">
            <i class="bi bi-funnel"></i>
            Filter Reports
        </h6>
        <button class="btn btn-secondary" onclick="document.getElementById('filterForm').reset();">
            <i class="bi bi-arrow-clockwise"></i>
            Reset Filters
        </button>
    </div>
    
    <form method="get" id="filterForm">
        <div class="filter-grid">
            <div class="form-group">
                <label for="fiscal_year">Fiscal Year</label>
                <select name="fiscal_year" id="fiscal_year" class="form-control">
                    <option value="">All Years</option>
                    {% for fy in fiscal_years %}
                    <option value="{{ fy.id }}" {% if fiscal_year.id == fy.id %}selected{% endif %}>
                        {{ fy.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="date_from">Date From</label>
                <input type="date" name="date_from" id="date_from" class="form-control" 
                       value="{{ date_from }}">
            </div>
            
            <div class="form-group">
                <label for="date_to">Date To</label>
                <input type="date" name="date_to" id="date_to" class="form-control" 
                       value="{{ date_to }}">
            </div>
            
            <div class="form-group">
                <label for="ward">Ward</label>
                <select name="ward" id="ward" class="form-control">
                    <option value="">All Wards</option>
                    {% for ward in wards %}
                    <option value="{{ ward.id }}" {% if selected_ward == ward.id|stringformat:"s" %}selected{% endif %}>
                        {{ ward.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="institution_type">Institution Type</label>
                <select name="institution_type" id="institution_type" class="form-control">
                    <option value="">All Types</option>
                    {% for value, label in institution_types %}
                    <option value="{{ value }}" {% if selected_institution_type == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="payment_method">Payment Method</label>
                <select name="payment_method" id="payment_method" class="form-control">
                    <option value="">All Methods</option>
                    {% for value, label in payment_methods %}
                    <option value="{{ value }}" {% if selected_payment_method == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
                Apply Filters
            </button>
        </div>
    </form>
</div>

<!-- Summary Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon blue">
                <i class="bi bi-cash-stack"></i>
            </div>
            <div class="stat-badge">
                <i class="bi bi-graph-up"></i> Total
            </div>
        </div>
        <div class="stat-value">KES {{ total_disbursed|floatformat:0|intcomma }}</div>
        <div class="stat-label">Total Disbursed</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon green">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-badge">
                <i class="bi bi-person-check"></i> Beneficiaries
            </div>
        </div>
        <div class="stat-value">{{ total_beneficiaries|intcomma }}</div>
        <div class="stat-label">Total Beneficiaries</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon purple">
                <i class="bi bi-calculator"></i>
            </div>
            <div class="stat-badge">
                <i class="bi bi-bar-chart"></i> Average
            </div>
        </div>
        <div class="stat-value">KES {{ average_amount|floatformat:0|intcomma }}</div>
        <div class="stat-label">Average Amount</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon yellow">
                <i class="bi bi-arrow-down-circle"></i>
            </div>
            <div class="stat-badge">
                <i class="bi bi-dash-circle"></i> Minimum
            </div>
        </div>
        <div class="stat-value">KES {{ min_amount|floatformat:0|intcomma }}</div>
        <div class="stat-label">Minimum Amount</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon red">
                <i class="bi bi-arrow-up-circle"></i>
            </div>
            <div class="stat-badge">
                <i class="bi bi-plus-circle"></i> Maximum
            </div>
        </div>
        <div class="stat-value">KES {{ max_amount|floatformat:0|intcomma }}</div>
        <div class="stat-label">Maximum Amount</div>
    </div>
</div>

<!-- Monthly Trend -->
<div class="content-card">
    <div class="card-header-custom">
        <h6 class="card-title">
            <i class="bi bi-graph-up"></i>
            Monthly Disbursement Trend
        </h6>
    </div>
    <div class="chart-container" style="min-height: 350px;">
        <canvas id="monthlyTrendChart"></canvas>
    </div>
</div>

<!-- Primary Charts Grid -->
<div class="grid-layout-thirds">
    <!-- Institution Type Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-building"></i>
                By Institution Type
            </h6>
        </div>
        <div class="chart-container">
            <canvas id="institutionTypeChart"></canvas>
        </div>
    </div>

    <!-- Payment Method Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-credit-card"></i>
                By Payment Method
            </h6>
        </div>
        <div class="chart-container">
            <canvas id="paymentMethodChart"></canvas>
        </div>
    </div>

    <!-- Gender Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-gender-ambiguous"></i>
                By Gender
            </h6>
        </div>
        <div class="chart-container">
            <canvas id="genderDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Geographic Distribution Charts -->
<div class="grid-layout">
    <!-- Ward Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-map"></i>
                Top 15 Wards
            </h6>
        </div>
        <div class="chart-container" style="min-height: 400px;">
            <canvas id="wardDistributionChart"></canvas>
        </div>
    </div>

    <!-- Constituency Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-geo-alt"></i>
                By Constituency
            </h6>
        </div>
        <div class="chart-container">
            <canvas id="constituencyDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Category and Institution Analysis -->
<div class="grid-layout">
    <!-- Category Distribution -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-tags"></i>
                Top 10 Categories
            </h6>
        </div>
        <div class="chart-container" style="min-height: 400px;">
            <canvas id="categoryDistributionChart"></canvas>
        </div>
    </div>

    <!-- Top Institutions -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-award"></i>
                Top 10 Institutions
            </h6>
        </div>
        <div class="chart-container" style="min-height: 400px;">
            <canvas id="topInstitutionsChart"></canvas>
        </div>
    </div>
</div>

<!-- Weekly Trend -->
<div class="content-card">
    <div class="card-header-custom">
        <h6 class="card-title">
            <i class="bi bi-calendar-week"></i>
            Weekly Disbursement Trend (Last 12 Weeks)
        </h6>
    </div>
    <div class="chart-container" style="min-height: 300px;">
        <canvas id="weeklyTrendChart"></canvas>
    </div>
</div>

<!-- Detailed Breakdowns Tables -->
<div class="grid-layout">
    <!-- Ward Breakdown Table -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-table"></i>
                Ward-wise Breakdown
            </h6>
        </div>
        <div class="table-responsive">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Amount</th>
                        <th>Beneficiaries</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward in ward_breakdown|slice:":10" %}
                    <tr>
                        <td style="font-weight: 600;">
                            {{ ward.application__applicant__ward__name|default:"Unknown" }}
                        </td>
                        <td style="color: #10B981; font-weight: 600;">
                            KES {{ ward.total|floatformat:0|intcomma }}
                        </td>
                        <td>
                            <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                {{ ward.count }}
                            </span>
                        </td>
                        <td style="font-weight: 500; color: #64748B;">
                            KES {{ ward.average|floatformat:0|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Institution Breakdown Table -->
    <div class="content-card">
        <div class="card-header-custom">
            <h6 class="card-title">
                <i class="bi bi-table"></i>
                Institution-wise Breakdown
            </h6>
        </div>
        <div class="table-responsive">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>Institution</th>
                        <th>Amount</th>
                        <th>Students</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inst in institution_breakdown|slice:":10" %}
                    <tr>
                        <td style="font-weight: 600;">
                            {{ inst.application__institution__name|truncatewords:4 }}
                        </td>
                        <td style="color: #10B981; font-weight: 600;">
                            KES {{ inst.total|floatformat:0|intcomma }}
                        </td>
                        <td>
                            <span style="background: rgba(245, 158, 11, 0.1); color: #F59E0B; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                {{ inst.count }}
                            </span>
                        </td>
                        <td style="font-weight: 500; color: #64748B;">
                            KES {{ inst.average|floatformat:0|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}