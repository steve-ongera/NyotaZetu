{% extends 'admin_base.html' %}
{% load humanize %}

{% block title %}Constituency Dashboard - {{ constituency.name }}{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'constituency_dashboard' %}">Dashboard</a>
        <span class="separator">/</span>
        <span class="current">Overview</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>{{ constituency.name }} Constituency Dashboard</h1>
            <p>CDF Bursary Management & Operations</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'constituency_reports' %}" class="btn btn-secondary">
                <i class="icon-report"></i> Reports
            </a>
            <a href="{% url 'constituency_settings' %}" class="btn btn-secondary">
                <i class="icon-settings"></i> Settings
            </a>
        </div>
    </div>

    <!-- Alerts Section -->
    {% if alerts %}
    <div class="alerts-section">
        {% for alert in alerts %}
        <div class="alert alert-{{ alert.type }}">
            <i class="icon-warning"></i>
            <p>{{ alert.message }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="icon-applications"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_applications|intcomma }}</h3>
                <p>Total Applications</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="icon-pending"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.pending_review|intcomma }}</h3>
                <p>Pending Review</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="icon-approved"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.approved|intcomma }}</h3>
                <p>Approved</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="icon-disbursed"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.disbursed|intcomma }}</h3>
                <p>Disbursed</p>
            </div>
        </div>
    </div>

    <!-- Financial Overview -->
    <div class="content-section">
        <div class="section-header">
            <h2>Financial Overview - {{ current_fiscal_year.name }}</h2>
        </div>
        <div class="financial-grid">
            <div class="financial-item">
                <label>CDF Budget Allocation</label>
                <div class="amount">KES {{ cdf_budget|floatformat:2|intcomma }}</div>
            </div>
            <div class="financial-item">
                <label>Total Requested</label>
                <div class="amount">KES {{ total_requested|floatformat:2|intcomma }}</div>
            </div>
            <div class="financial-item">
                <label>Total Allocated</label>
                <div class="amount">KES {{ total_allocated|floatformat:2|intcomma }}</div>
            </div>
            <div class="financial-item">
                <label>Total Disbursed</label>
                <div class="amount">KES {{ total_disbursed|floatformat:2|intcomma }}</div>
            </div>
            <div class="financial-item">
                <label>Budget Available</label>
                <div class="amount">KES {{ budget_available|floatformat:2|intcomma }}</div>
            </div>
            <div class="financial-item">
                <label>Budget Utilization</label>
                <div class="amount">{{ budget_utilization|floatformat:1 }}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ budget_utilization }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ward Statistics -->
    <div class="content-section">
        <div class="section-header">
            <h2>Ward-wise Breakdown</h2>
            <a href="{% url 'constituency_wards_overview' %}" class="btn btn-link">View All Wards</a>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Applications</th>
                        <th>Approved</th>
                        <th>Amount Requested</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward_stat in ward_stats %}
                    <tr>
                        <td>{{ ward_stat.ward.name }}</td>
                        <td>{{ ward_stat.applications }}</td>
                        <td>{{ ward_stat.approved }}</td>
                        <td>KES {{ ward_stat.amount_requested|floatformat:2|intcomma }}</td>
                        <td>
                            <a href="{% url 'constituency_ward_detail' ward_stat.ward.id %}" class="btn btn-sm">
                                View Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Applications -->
    <div class="content-section">
        <div class="section-header">
            <h2>Recent Applications</h2>
            <a href="{% url 'constituency_applications_list' %}" class="btn btn-link">View All Applications</a>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Application No.</th>
                        <th>Applicant</th>
                        <th>Ward</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in recent_applications %}
                    <tr>
                        <td>{{ app.application_number }}</td>
                        <td>{{ app.applicant.user.get_full_name }}</td>
                        <td>{{ app.applicant.ward.name|default:"N/A" }}</td>
                        <td>KES {{ app.amount_requested|floatformat:2|intcomma }}</td>
                        <td>
                            <span class="badge badge-{{ app.status }}">{{ app.get_status_display }}</span>
                        </td>
                        <td>{{ app.date_submitted|date:"M d, Y" }}</td>
                        <td>
                            <a href="{% url 'constituency_application_detail' app.id %}" class="btn btn-sm">
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pending Reviews -->
    {% if pending_reviews %}
    <div class="content-section">
        <div class="section-header">
            <h2>Pending Reviews</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Application No.</th>
                        <th>Applicant</th>
                        <th>Amount</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in pending_reviews %}
                    <tr>
                        <td>{{ app.application_number }}</td>
                        <td>{{ app.applicant.user.get_full_name }}</td>
                        <td>KES {{ app.amount_requested|floatformat:2|intcomma }}</td>
                        <td>{{ app.date_submitted|date:"M d, Y" }}</td>
                        <td>
                            <a href="{% url 'constituency_application_detail' app.id %}" class="btn btn-sm btn-primary">
                                Review Now
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}