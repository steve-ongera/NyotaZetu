{% extends 'base.html' %}
{% load humanize %}

{% block title %}Send Notifications - {{ constituency.name }}{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'constituency_dashboard' %}">Dashboard</a>
        <span class="separator">/</span>
        <span class="current">Send Notifications</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Send Bulk Notifications</h1>
        <p>Send notifications to applicants and beneficiaries</p>
    </div>

    <!-- Notification Form -->
    <div class="content-section">
        <h2>Compose Notification</h2>
        
        <form method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="recipient_type">Recipient Group</label>
                <select name="recipient_type" id="recipient_type" class="form-control" required>
                    <option value="">Select recipient group</option>
                    <option value="all">All Applicants</option>
                    <option value="pending">Pending Applications</option>
                    <option value="approved">Approved Applications</option>
                    <option value="rejected">Rejected Applications</option>
                    <option value="disbursed">Disbursed Applications</option>
                    <option value="under_review">Applications Under Review</option>
                </select>
                <small class="form-help">Select which group of applicants to notify</small>
            </div>

            <div class="form-group">
                <label for="message_title">Message Title</label>
                <input type="text" name="message_title" id="message_title" class="form-control" 
                       required placeholder="Enter notification title" maxlength="200">
            </div>

            <div class="form-group">
                <label for="message_text">Message Content</label>
                <textarea name="message_text" id="message_text" class="form-control" 
                          rows="8" required placeholder="Enter your message here..."></textarea>
                <small class="form-help">
                    Character count: <span id="char-count">0</span> / 500
                </small>
            </div>

            <div class="form-group">
                <label>Delivery Methods</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" name="send_sms" id="send_sms">
                        <label for="send_sms">Send via SMS</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="send_email" id="send_email">
                        <label for="send_email">Send via Email</label>
                    </div>
                </div>
                <small class="form-help">
                    Select at least one delivery method. In-app notifications will always be sent.
                </small>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h3>Preview</h3>
                <div class="notification-preview">
                    <div class="preview-title" id="preview-title">Message Title</div>
                    <div class="preview-content" id="preview-content">Message content will appear here...</div>
                    <div class="preview-meta">
                        <span>From: {{ constituency.name }} CDF Office</span>
                        <span id="recipient-count">Recipients: 0</span>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="icon-send"></i> Send Notifications
                </button>
                <a href="{% url 'constituency_dashboard' %}" class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Guidelines -->
    <div class="content-section">
        <h2>Notification Guidelines</h2>
        <div class="guidelines-content">
            <h3>Best Practices</h3>
            <ul>
                <li>Keep messages clear and concise</li>
                <li>Include all relevant information (dates, amounts, next steps)</li>
                <li>Be professional and respectful in tone</li>
                <li>Double-check all details before sending</li>
                <li>For SMS, keep messages under 160 characters for single message delivery</li>
            </ul>

            <h3>What to Include</h3>
            <ul>
                <li>Purpose of the notification</li>
                <li>Any action required from the recipient</li>
                <li>Relevant dates or deadlines</li>
                <li>Contact information for follow-up questions</li>
            </ul>

            <h3>Important Notes</h3>
            <ul>
                <li>SMS notifications may incur costs - use wisely</li>
                <li>Email notifications are free but may take longer to deliver</li>
                <li>All sent notifications are logged for audit purposes</li>
                <li>Recipients may not receive SMS/email immediately</li>
                <li>Consider sending test notifications to yourself first</li>
            </ul>
        </div>
    </div>

    <!-- Recent Notifications -->
    <div class="content-section">
        <h2>Recent Notifications Sent</h2>
        <div class="notifications-list">
            <div class="notification-item">
                <div class="notification-header">
                    <h4>Sample: Application Review Update</h4>
                    <span class="notification-date">Jan 15, 2025</span>
                </div>
                <p class="notification-content">
                    Your CDF bursary application has been reviewed and approved...
                </p>
                <div class="notification-meta">
                    <span>Recipients: 45</span>
                    <span>Via: SMS, Email</span>
                    <span class="badge badge-success">Delivered</span>
                </div>
            </div>

            <div class="notification-item">
                <div class="notification-header">
                    <h4>Sample: Disbursement Notice</h4>
                    <span class="notification-date">Jan 10, 2025</span>
                </div>
                <p class="notification-content">
                    Your bursary has been disbursed to your institution...
                </p>
                <div class="notification-meta">
                    <span>Recipients: 32</span>
                    <span>Via: SMS, Email</span>
                    <span class="badge badge-success">Delivered</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageTitle = document.getElementById('message_title');
    const messageText = document.getElementById('message_text');
    const previewTitle = document.getElementById('preview-title');
    const previewContent = document.getElementById('preview-content');
    const charCount = document.getElementById('char-count');
    const recipientType = document.getElementById('recipient_type');
    const recipientCount = document.getElementById('recipient-count');

    // Update preview on input
    messageTitle.addEventListener('input', function() {
        previewTitle.textContent = this.value || 'Message Title';
    });

    messageText.addEventListener('input', function() {
        previewContent.textContent = this.value || 'Message content will appear here...';
        charCount.textContent = this.value.length;
    });

    // Update recipient count (would be AJAX in real implementation)
    recipientType.addEventListener('change', function() {
        // This would typically be an AJAX call to get actual count
        const counts = {
            'all': 150,
            'pending': 45,
            'approved': 80,
            'rejected': 15,
            'disbursed': 60,
            'under_review': 25
        };
        recipientCount.textContent = 'Recipients: ' + (counts[this.value] || 0);
    });

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const sendSMS = document.getElementById('send_sms').checked;
        const sendEmail = document.getElementById('send_email').checked;
        
        if (!sendSMS && !sendEmail) {
            e.preventDefault();
            alert('Please select at least one delivery method (SMS or Email)');
            return false;
        }

        if (messageText.value.length > 500) {
            e.preventDefault();
            alert('Message is too long. Maximum 500 characters allowed.');
            return false;
        }

        return confirm('Are you sure you want to send this notification to ' + recipientCount.textContent.split(': ')[1] + ' recipients?');
    });
});
</script>

<style>
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.checkbox-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
}

.preview-section {
    margin: 30px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.notification-preview {
    background: white;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #ddd;
}

.preview-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
}

.preview-content {
    margin-bottom: 20px;
    line-height: 1.6;
    color: #333;
}

.preview-meta {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #666;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.form-help {
    display: block;
    margin-top: 5px;
    font-size: 13px;
    color: #666;
}

.guidelines-content h3 {
    margin-top: 20px;
    margin-bottom: 10px;
}

.guidelines-content ul {
    margin-left: 20px;
    line-height: 1.8;
}

.notifications-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #0066cc;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.notification-header h4 {
    margin: 0;
    font-size: 16px;
}

.notification-date {
    font-size: 13px;
    color: #666;
}

.notification-content {
    margin: 10px 0;
    color: #333;
}

.notification-meta {
    display: flex;
    gap: 20px;
    font-size: 13px;
    color: #666;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}
</style>
{% endblock %}