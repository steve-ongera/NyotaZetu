{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ applicant.user.get_full_name }} - Beneficiary Profile{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'constituency_dashboard' %}">Dashboard</a>
        <span class="separator">/</span>
        <a href="{% url 'constituency_beneficiaries' %}">Beneficiaries</a>
        <span class="separator">/</span>
        <span class="current">{{ applicant.user.get_full_name }}</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>{{ applicant.user.get_full_name }}</h1>
            <p>Beneficiary Profile & History</p>
        </div>
        <div class="header-actions">
            <a href="{% url 'constituency_beneficiaries' %}" class="btn btn-secondary">
                <i class="icon-back"></i> Back to List
            </a>
        </div>
    </div>

    <div class="content-grid">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Personal Information -->
            <div class="content-section">
                <h2>Personal Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Full Name</label>
                        <p>{{ applicant.user.get_full_name }}</p>
                    </div>
                    <div class="info-item">
                        <label>ID Number</label>
                        <p>{{ applicant.id_number }}</p>
                    </div>
                    <div class="info-item">
                        <label>Gender</label>
                        <p>{{ applicant.get_gender_display }}</p>
                    </div>
                    <div class="info-item">
                        <label>Date of Birth</label>
                        <p>{{ applicant.date_of_birth|date:"M d, Y" }}</p>
                    </div>
                    <div class="info-item">
                        <label>Phone Number</label>
                        <p>{{ applicant.user.phone_number }}</p>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <p>{{ applicant.user.email }}</p>
                    </div>
                </div>
            </div>

            <!-- Location Information -->
            <div class="content-section">
                <h2>Location Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>County</label>
                        <p>{{ applicant.county.name }}</p>
                    </div>
                    <div class="info-item">
                        <label>Constituency</label>
                        <p>{{ applicant.constituency.name }}</p>
                    </div>
                    <div class="info-item">
                        <label>Ward</label>
                        <p>{{ applicant.ward.name|default:"N/A" }}</p>
                    </div>
                    <div class="info-item">
                        <label>Location</label>
                        <p>{{ applicant.location.name|default:"N/A" }}</p>
                    </div>
                    <div class="info-item">
                        <label>Sub-location</label>
                        <p>{{ applicant.sublocation.name|default:"N/A" }}</p>
                    </div>
                    <div class="info-item">
                        <label>Village</label>
                        <p>{{ applicant.village.name|default:"N/A" }}</p>
                    </div>
                </div>
            </div>

            <!-- Application History -->
            <div class="content-section">
                <h2>Application History</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Application No.</th>
                                <th>Fiscal Year</th>
                                <th>Institution</th>
                                <th>Amount Requested</th>
                                <th>Status</th>
                                <th>Date Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for app in applications %}
                            <tr>
                                <td>{{ app.application_number }}</td>
                                <td>{{ app.fiscal_year.name }}</td>
                                <td>{{ app.institution.name|truncatewords:3 }}</td>
                                <td>KES {{ app.amount_requested|floatformat:2|intcomma }}</td>
                                <td>
                                    <span class="badge badge-{{ app.status }}">{{ app.get_status_display }}</span>
                                </td>
                                <td>{{ app.date_submitted|date:"M d, Y"|default:"N/A" }}</td>
                                <td>
                                    <a href="{% url 'constituency_application_detail' app.id %}" class="btn btn-sm">
                                        View
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">
                                    <p>No applications found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Allocation History -->
            <div class="content-section">
                <h2>Allocation History</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fiscal Year</th>
                                <th>Application</th>
                                <th>Amount Allocated</th>
                                <th>Allocation Date</th>
                                <th>Disbursement Status</th>
                                <th>Disbursement Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for allocation in allocations %}
                            <tr>
                                <td>{{ allocation.application.fiscal_year.name }}</td>
                                <td>{{ allocation.application.application_number }}</td>
                                <td>KES {{ allocation.amount_allocated|floatformat:2|intcomma }}</td>
                                <td>{{ allocation.allocation_date|date:"M d, Y" }}</td>
                                <td>
                                    {% if allocation.is_disbursed %}
                                    <span class="badge badge-success">Disbursed</span>
                                    {% else %}
                                    <span class="badge badge-warning">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if allocation.disbursement_date %}
                                    {{ allocation.disbursement_date|date:"M d, Y" }}
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">
                                    <p>No allocations found.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Summary Statistics -->
            <div class="sidebar-section">
                <h3>Summary Statistics</h3>
                <div class="summary-list">
                    <div class="summary-item">
                        <label>Total Applications</label>
                        <p>{{ applications.count }}</p>
                    </div>
                    <div class="summary-item">
                        <label>Total Received</label>
                        <p class="amount-highlight">KES {{ total_received|floatformat:2|intcomma }}</p>
                    </div>
                    <div class="summary-item">
                        <label>Years Assisted</label>
                        <p>{{ allocations.count }}</p>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="sidebar-section">
                <h3>Quick Links</h3>
                <div class="action-list">
                    {% for app in applications %}
                    {% if app.status == 'submitted' or app.status == 'under_review' %}
                    <a href="{% url 'constituency_application_detail' app.id %}" class="action-link">
                        <i class="icon-document"></i> Review {{ app.fiscal_year.name }} Application
                    </a>
                    {% endif %}
                    {% endfor %}
                    <a href="{% url 'constituency_beneficiaries' %}?search={{ applicant.id_number }}" class="action-link">
                        <i class="icon-search"></i> Search Applications
                    </a>
                    <a href="{% url 'constituency_ward_detail' applicant.ward.id %}" class="action-link">
                        <i class="icon-location"></i> View Ward Applications
                    </a>
                </div>
            </div>

            <!-- Beneficiary Notes -->
            <div class="sidebar-section">
                <h3>Notes</h3>
                <div class="notes-content">
                    {% if applicant.special_needs %}
                    <div class="note-item alert-info">
                        <h4>Special Needs</h4>
                        <p>{{ applicant.special_needs_description|default:"Yes" }}</p>
                    </div>
                    {% endif %}
                    
                    <p class="text-muted">
                        This beneficiary has been assisted through the CDF bursary program 
                        for {{ allocations.count }} fiscal year{{ allocations.count|pluralize }}.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}