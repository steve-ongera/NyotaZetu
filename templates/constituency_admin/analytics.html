{% extends 'base.html' %}
{% load humanize %}

{% block title %}Analytics - {{ constituency.name }}{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'constituency_dashboard' %}">Dashboard</a>
        <span class="separator">/</span>
        <span class="current">Analytics</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>CDF Bursary Analytics</h1>
            <p>{{ constituency.name }} Constituency - {{ current_fiscal_year.name }}</p>
        </div>
        <div class="header-actions">
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="icon-print"></i> Print Report
            </button>
        </div>
    </div>

    <!-- Gender Distribution -->
    <div class="content-section">
        <h2>Gender Distribution</h2>
        <div class="analytics-grid">
            {% for gender in gender_dist %}
            <div class="analytics-card">
                <div class="analytics-icon">
                    <i class="icon-{% if gender.applicant__gender == 'M' %}male{% else %}female{% endif %}"></i>
                </div>
                <div class="analytics-content">
                    <h3>{{ gender.count|intcomma }}</h3>
                    <p>{{ gender.applicant__gender|default:"Unknown" }}</p>
                    <div class="analytics-meta">
                        KES {{ gender.total_amount|floatformat:2|intcomma|default:"0" }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Institution Type Distribution -->
    <div class="content-section">
        <h2>Distribution by Institution Type</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Institution</th>
                        <th>Type</th>
                        <th>Applications</th>
                        <th>Total Allocated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inst in institution_dist %}
                    <tr>
                        <td>{{ inst.institution__name|default:"N/A" }}</td>
                        <td>{{ inst.institution__institution_type|default:"N/A" }}</td>
                        <td>{{ inst.count }}</td>
                        <td>KES {{ inst.total_allocated|floatformat:2|intcomma|default:"0" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ward Distribution -->
    <div class="content-section">
        <h2>Distribution by Ward</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Total Applications</th>
                        <th>Approved</th>
                        <th>Amount Requested</th>
                        <th>Amount Allocated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward in ward_dist %}
                    <tr>
                        <td>{{ ward.applicant__ward__name|default:"N/A" }}</td>
                        <td>{{ ward.count }}</td>
                        <td>{{ ward.approved }}</td>
                        <td>KES {{ ward.total_requested|floatformat:2|intcomma|default:"0" }}</td>
                        <td>KES {{ ward.total_allocated|floatformat:2|intcomma|default:"0" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Monthly Trends -->
    <div class="content-section">
        <h2>Monthly Application Trends</h2>
        <div class="chart-placeholder">
            <div class="chart-info">
                <p>Chart showing monthly application submissions and approvals</p>
                <div class="trend-data">
                    {% for trend in monthly_trends %}
                    <div class="trend-item">
                        <div class="trend-month">{{ trend.month|date:"M Y" }}</div>
                        <div class="trend-stats">
                            <span>Applications: {{ trend.applications }}</span>
                            <span>Approved: {{ trend.approved }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Category Distribution -->
    <div class="content-section">
        <h2>Distribution by Category</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Applications</th>
                        <th>Total Allocated</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat in category_dist %}
                    <tr>
                        <td>{{ cat.bursary_category__name|default:"N/A" }}</td>
                        <td>{{ cat.bursary_category__category_type|default:"N/A" }}</td>
                        <td>{{ cat.count }}</td>
                        <td>KES {{ cat.total_allocated|floatformat:2|intcomma|default:"0" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Orphan Statistics -->
    <div class="content-section">
        <h2>Vulnerable Groups Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="icon-users"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ orphan_stats.total_orphans }}</h3>
                    <p>Total Orphans Assisted</p>
                    <div class="stat-meta">
                        KES {{ orphan_stats.total_orphans_amount|floatformat:2|intcomma }}
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <i class="icon-heart"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ special_needs_stats.total_special_needs }}</h3>
                    <p>Special Needs Students</p>
                    <div class="stat-meta">
                        KES {{ special_needs_stats.total_special_needs_amount|floatformat:2|intcomma }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ward Success Rate -->
    <div class="content-section">
        <h2>Ward Success Rate Comparison</h2>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ward</th>
                        <th>Total Applications</th>
                        <th>Approved</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ward in ward_success_rate %}
                    <tr>
                        <td>{{ ward.ward }}</td>
                        <td>{{ ward.total }}</td>
                        <td>{{ ward.approved }}</td>
                        <td>
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{ ward.success_rate }}%"></div>
                                </div>
                                <span class="progress-label">{{ ward.success_rate|floatformat:1 }}%</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Key Insights -->
    <div class="content-section">
        <h2>Key Insights</h2>
        <div class="insights-grid">
            <div class="insight-card">
                <h4>Most Active Ward</h4>
                <p>{{ ward_dist.0.applicant__ward__name|default:"N/A" }}</p>
                <span>{{ ward_dist.0.count|default:0 }} applications</span>
            </div>

            <div class="insight-card">
                <h4>Average Amount Requested</h4>
                <p>KES {{ ward_dist.0.total_requested|default:0|floatformat:2|intcomma }}</p>
                <span>Per application</span>
            </div>

            <div class="insight-card">
                <h4>Top Institution Type</h4>
                <p>{{ institution_dist.0.institution__institution_type|default:"N/A" }}</p>
                <span>{{ institution_dist.0.count|default:0 }} students</span>
            </div>

            <div class="insight-card">
                <h4>Overall Approval Rate</h4>
                {% if ward_dist %}
                <p>
                    {% widthratio ward_dist.0.approved ward_dist.0.count 100 %}%
                </p>
                {% else %}
                <p>N/A</p>
                {% endif %}
                <span>Applications approved</span>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="content-section">
        <h2>Export Analytics</h2>
        <div class="export-options">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="icon-print"></i> Print Analytics Report
            </button>
            <a href="{% url 'constituency_export_data' %}?type=all_applications&fiscal_year={{ current_fiscal_year.id }}" 
               class="btn btn-secondary">
                <i class="icon-download"></i> Export to Excel
            </a>
        </div>
    </div>
</div>

<style>
.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.analytics-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 15px;
}

.analytics-icon {
    width: 50px;
    height: 50px;
    background: #0066cc;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.analytics-content h3 {
    margin: 0;
    font-size: 28px;
}

.analytics-content p {
    margin: 5px 0;
    color: #666;
}

.analytics-meta {
    font-size: 14px;
    color: #0066cc;
    font-weight: bold;
}

.chart-placeholder {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 8px;
    text-align: center;
    min-height: 300px;
}

.trend-data {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.trend-item {
    background: white;
    padding: 15px;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.trend-month {
    font-weight: bold;
}

.trend-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #666;
}

.progress-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar {
    flex: 1;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #0066cc, #0088ff);
    transition: width 0.3s;
}

.progress-label {
    font-weight: bold;
    color: #0066cc;
}

.insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.insight-card {
    background: linear-gradient(135deg, #0066cc 0%, #0088ff 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
}

.insight-card h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
}

.insight-card p {
    margin: 0 0 5px 0;
    font-size: 24px;
    font-weight: bold;
}

.insight-card span {
    font-size: 13px;
    opacity: 0.8;
}

.export-options {
    display: flex;
    gap: 15px;
}

@media print {
    .page-header .header-actions,
    .export-options,
    .breadcrumb {
        display: none;
    }
}
</style>
{% endblock %}