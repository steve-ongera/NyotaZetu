{% extends 'admin_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Security & Audit Dashboard{% endblock %}

{% block extra_css %}
<style>
    .security-dashboard {
        padding: 20px;
    }

    .breadcrumb {
        padding: 0;
        margin-bottom: 20px;
        font-size: 14px;
        list-style: none;
        display: flex;
        flex-wrap: wrap;
    }

    .breadcrumb-item {
        color: #64748B;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/ ";
        color: #94A3B8;
        padding: 0 8px;
    }

    .breadcrumb-item.active {
        color: #1E293B;
        font-weight: 500;
    }

    .breadcrumb a {
        color: #3498db;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #F1F5F9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chart-container canvas {
        max-width: 100% !important;
        height: 250px !important;
    }


    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: #D1FAE5;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        color: #065F46;
    }

    .live-dot {
        width: 8px;
        height: 8px;
        background: #10B981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .stat-card.primary::before {
        background: linear-gradient(180deg, #3498db, #2980b9);
    }

    .stat-card.success::before {
        background: linear-gradient(180deg, #27ae60, #229954);
    }

    .stat-card.danger::before {
        background: linear-gradient(180deg, #e74c3c, #c0392b);
    }

    .stat-card.warning::before {
        background: linear-gradient(180deg, #f39c12, #e67e22);
    }

    .stat-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1E293B;
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-trend {
        font-size: 12px;
        color: #64748B;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .trend-up {
        color: #27ae60;
    }

    .trend-down {
        color: #e74c3c;
    }

    .chart-container {
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #F1F5F9;
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-controls {
        display: flex;
        gap: 8px;
    }

    .chart-btn {
        padding: 6px 12px;
        background: #F8FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .chart-btn:hover, .chart-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .data-table thead th {
        background: #F8FAFC;
        padding: 12px 16px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: #64748B;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #E2E8F0;
        white-space: nowrap;
    }

    .data-table tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #F1F5F9;
        font-size: 13px;
        color: #334155;
    }

    .data-table tbody tr:hover {
        background-color: #F8FAFC;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-success {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-danger {
        background: #FEE2E2;
        color: #991B1B;
    }

    .badge-warning {
        background: #FEF3C7;
        color: #92400E;
    }

    .badge-info {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .badge-critical {
        background: #FEE2E2;
        color: #7F1D1D;
        animation: criticalPulse 2s infinite;
    }

    @keyframes criticalPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .threat-item {
        padding: 12px;
        background: #FEF2F2;
        border-left: 3px solid #e74c3c;
        border-radius: 6px;
        margin-bottom: 12px;
    }

    .threat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .threat-type {
        font-weight: 600;
        color: #1E293B;
        font-size: 14px;
    }

    .threat-time {
        font-size: 11px;
        color: #64748B;
    }

    .threat-description {
        font-size: 12px;
        color: #64748B;
        margin-bottom: 8px;
    }

    .threat-meta {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #64748B;
    }

    .action-btn {
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .action-btn:hover {
        background: #2980b9;
    }

    .action-btn.secondary {
        background: #64748B;
    }

    .action-btn.secondary:hover {
        background: #475569;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #64748B;
    }

    .empty-icon {
        font-size: 48px;
        color: #CBD5E1;
        margin-bottom: 12px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }

    .session-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #F8FAFC;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .session-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
    }

    .session-info {
        flex: 1;
    }

    .session-user {
        font-weight: 600;
        color: #1E293B;
        font-size: 13px;
        margin-bottom: 2px;
    }

    .session-details {
        font-size: 11px;
        color: #64748B;
    }

    .refresh-btn {
        padding: 8px 16px;
        background: white;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        color: #64748B;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .refresh-btn:hover {
        background: #F8FAFC;
        border-color: #3498db;
        color: #3498db;
    }

    .refresh-btn.rotating i {
        animation: rotate 1s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .grid-2 {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="security-dashboard">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'admin_dashboard' %}">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Security & Audit</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="section-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-shield-lock"></i>
                    Security & Audit Dashboard
                    <span class="live-indicator">
                        <span class="live-dot"></span>
                        LIVE
                    </span>
                </h1>
                <p class="page-subtitle" style="color: #64748B; margin: 0;">
                    Real-time security monitoring and threat detection
                </p>
            </div>
            <button class="refresh-btn" onclick="refreshAllData()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh Data
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-label">
                    <i class="bi bi-people"></i>
                    Active Users
                </div>
                <div class="stat-value" id="stat-active-users">{{ security_stats.active_sessions }}</div>
                <div class="stat-trend">
                    Right now
                </div>
            </div>

            <div class="stat-card success">
                <div class="stat-label">
                    <i class="bi bi-check-circle"></i>
                    Successful Logins
                </div>
                <div class="stat-value" id="stat-logins">{{ security_stats.total_logins_today }}</div>
                <div class="stat-trend">
                    Today
                </div>
            </div>

            <div class="stat-card danger">
                <div class="stat-label">
                    <i class="bi bi-exclamation-triangle"></i>
                    Security Threats
                </div>
                <div class="stat-value" id="stat-threats">{{ security_stats.threats_unresolved }}</div>
                <div class="stat-trend">
                    Unresolved
                </div>
            </div>

            <div class="stat-card warning">
                <div class="stat-label">
                    <i class="bi bi-eye-slash"></i>
                    Suspicious Activities
                </div>
                <div class="stat-value" id="stat-suspicious">{{ security_stats.suspicious_uninvestigated }}</div>
                <div class="stat-trend">
                    Uninvestigated
                </div>
            </div>

            <div class="stat-card danger">
                <div class="stat-label">
                    <i class="bi bi-x-circle"></i>
                    Failed Logins
                </div>
                <div class="stat-value" id="stat-failed">{{ security_stats.failed_login_attempts_today }}</div>
                <div class="stat-trend">
                    Today
                </div>
            </div>

            <div class="stat-card primary">
                <div class="stat-label">
                    <i class="bi bi-lock"></i>
                    Locked Accounts
                </div>
                <div class="stat-value">{{ security_stats.locked_accounts }}</div>
                <div class="stat-trend">
                    Total
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid-2">
        <!-- User Activity Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-activity"></i>
                    User Activity Timeline
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="loadActivityChart(24)" data-hours="24">24h</button>
                    <button class="chart-btn" onclick="loadActivityChart(12)" data-hours="12">12h</button>
                    <button class="chart-btn" onclick="loadActivityChart(6)" data-hours="6">6h</button>
                </div>
            </div>
            <canvas id="activityChart" style="width: 500px; height: 250px;"></canvas>
        </div>

        <!-- Login Attempts Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-graph-up"></i>
                    Login Attempts
                </h3>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="loadLoginChart(7)" data-days="7">7d</button>
                    <button class="chart-btn" onclick="loadLoginChart(14)" data-days="14">14d</button>
                    <button class="chart-btn" onclick="loadLoginChart(30)" data-days="30">30d</button>
                </div>
            </div>
            <canvas id="loginChart" style="width: 500px; height: 250px;"></canvas>
        </div>
    </div>

    <!-- Threats and Activities -->
    <div class="grid-2">
        <!-- Security Threats -->
        <div class="section-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-shield-exclamation"></i>
                    Recent Security Threats
                </h3>
                <button class="refresh-btn" onclick="loadSecurityThreats()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div id="threats-container">
                {% if recent_threats %}
                    {% for threat in recent_threats %}
                    <div class="threat-item">
                        <div class="threat-header">
                            <span class="threat-type">{{ threat.get_threat_type_display }}</span>
                            <span class="badge badge-{{ threat.severity }}">{{ threat.severity }}</span>
                        </div>
                        <div class="threat-description">{{ threat.description }}</div>
                        <div class="threat-meta">
                            <span><i class="bi bi-geo-alt"></i> {{ threat.ip_address }}</span>
                            <span><i class="bi bi-clock"></i> {{ threat.detected_at|timesince }} ago</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <button class="action-btn" onclick="resolveThreat({{ threat.id }})">
                                Resolve
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon"><i class="bi bi-shield-check"></i></div>
                        <p>No unresolved threats</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Suspicious Activities -->
        <div class="section-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-eye-slash"></i>
                    Suspicious Activities
                </h3>
                <button class="refresh-btn" onclick="loadSuspiciousActivities()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div id="suspicious-container">
                {% if recent_suspicious %}
                    {% for activity in recent_suspicious %}
                    <div class="threat-item" style="background: #FEF9C3; border-color: #f39c12;">
                        <div class="threat-header">
                            <span class="threat-type">{{ activity.get_activity_type_display }}</span>
                            <span class="badge badge-warning">Risk: {{ activity.risk_score }}</span>
                        </div>
                        <div class="threat-description">
                            <strong>User:</strong> {{ activity.user.username }} - {{ activity.description }}
                        </div>
                        <div class="threat-meta">
                            <span><i class="bi bi-geo-alt"></i> {{ activity.ip_address }}</span>
                            <span><i class="bi bi-clock"></i> {{ activity.detected_at|timesince }} ago</span>
                            <span><i class="bi bi-percent"></i> {{ activity.confidence }}% confidence</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <button class="action-btn" onclick="investigateActivity({{ activity.id }})">
                                Investigate
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon"><i class="bi bi-check-circle"></i></div>
                        <p>No suspicious activities detected</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Active Sessions and Top URLs -->
    <div class="grid-2">
        <!-- Active Sessions -->
        <div class="section-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-broadcast"></i>
                    Active Sessions
                </h3>
                <button class="refresh-btn" onclick="loadActiveSessions()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div id="sessions-container">
                {% if active_sessions %}
                    {% for session in active_sessions %}
                    <div class="session-item">
                        <div class="session-avatar">
                            {{ session.user.first_name.0 }}{{ session.user.last_name.0 }}
                        </div>
                        <div class="session-info">
                            <div class="session-user">{{ session.user.get_full_name }}</div>
                            <div class="session-details">
                                <i class="bi bi-geo-alt"></i> {{ session.ip_address }} •
                                <i class="bi bi-clock"></i> {{ session.last_activity|timesince }} ago
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No active sessions</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Top URLs -->
        <div class="section-container">
            <div class="chart-header">
                <h3 class="chart-title">
                    <i class="bi bi-bar-chart"></i>
                    Most Visited URLs
                </h3>
                <button class="refresh-btn" onclick="loadTopURLs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>URL Path</th>
                        <th style="text-align: right;">Visits</th>
                    </tr>
                </thead>
                <tbody id="urls-container">
                    {% if top_urls %}
                        {% for url in top_urls %}
                        <tr>
                            <td>{{ url.url_path }}</td>
                            <td style="text-align: right;">
                                <strong>{{ url.visit_count|intcomma }}</strong>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="2">
                                <div class="empty-state">
                                    <p>No URL data available</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let activityChart, loginChart;
    let refreshInterval;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadActivityChart(24);
        loadLoginChart(7);
        
        // Auto-refresh every 30 seconds
        refreshInterval = setInterval(refreshAllData, 30000);
    });

    // Load activity chart
    function loadActivityChart(hours) {
        fetch(`/api/user-activity-chart/?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('activityChart').getContext('2d');
                
                if (activityChart) {
                    activityChart.destroy();
                }
                
                activityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Requests',
                            data: data.data,
                            borderColor: 'rgb(52, 152, 219)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Update active button
                document.querySelectorAll('.chart-controls button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            });
    }

    // Load login chart
    function loadLoginChart(days) {
        fetch(`/api/login-attempts-chart/?days=${days}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('loginChart').getContext('2d');
                
                if (loginChart) {
                    loginChart.destroy();
                }
                
                loginChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Update active button
                if (event && event.target) {
                    document.querySelectorAll('.chart-controls button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.target.classList.add('active');
                }
            });
    }

    // Refresh all data
    function refreshAllData() {
        const btn = event ? event.target : document.querySelector('.refresh-btn');
        btn.classList.add('rotating');
        
        // Update stats
        fetch('/api/security-stats/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('stat-active-users').textContent = data.active_users;
                document.getElementById('stat-threats').textContent = data.threats_today;
                document.getElementById('stat-suspicious').textContent = data.suspicious_activities;
                document.getElementById('stat-failed').textContent = data.failed_logins_today;
            });
        
        // Refresh other sections
        loadSecurityThreats();
        loadSuspiciousActivities();
        loadActiveSessions();
        loadTopURLs();
        
        setTimeout(() => {
            btn.classList.remove('rotating');
        }, 1000);
    }

    // Load security threats
    function loadSecurityThreats() {
        fetch('/api/security-threats/?unresolved=true&limit=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('threats-container');
                if (data.threats.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="bi bi-shield-check"></i></div>
                            <p>No unresolved threats</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.threats.map(threat => `
                        <div class="threat-item">
                            <div class="threat-header">
                                <span class="threat-type">${threat.threat_type}</span>
                                <span class="badge badge-${threat.severity}">${threat.severity}</span>
                            </div>
                            <div class="threat-description">${threat.description}</div>
                            <div class="threat-meta">
                                <span><i class="bi bi-geo-alt"></i> ${threat.ip_address}</span>
                                <span><i class="bi bi-person"></i> ${threat.user}</span>
                            </div>
                            <div style="margin-top: 8px;">
                                <button class="action-btn" onclick="resolveThreat(${threat.id})">
                                    Resolve
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            });
    }

    // Load suspicious activities
    function loadSuspiciousActivities() {
        fetch('/api/suspicious-activities/?uninvestigated=true&limit=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('suspicious-container');
                if (data.activities.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="bi bi-check-circle"></i></div>
                            <p>No suspicious activities detected</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.activities.map(activity => `
                        <div class="threat-item" style="background: #FEF9C3; border-color: #f39c12;">
                            <div class="threat-header">
                                <span class="threat-type">${activity.activity_type}</span>
                                <span class="badge badge-warning">Risk: ${activity.risk_score}</span>
                            </div>
                            <div class="threat-description">
                                <strong>User:</strong> ${activity.user} - ${activity.description}
                            </div>
                            <div class="threat-meta">
                                <span><i class="bi bi-percent"></i> ${activity.confidence}% confidence</span>
                            </div>
                            <div style="margin-top: 8px;">
                                <button class="action-btn" onclick="investigateActivity(${activity.id})">
                                    Investigate
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            });
    }

    // Load active sessions
    function loadActiveSessions() {
        fetch('/api/active-sessions/')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('sessions-container');
                if (data.sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No active sessions</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.sessions.map(session => `
                        <div class="session-item">
                            <div class="session-avatar">
                                ${session.user_full_name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div class="session-info">
                                <div class="session-user">${session.user_full_name}</div>
                                <div class="session-details">
                                    <i class="bi bi-geo-alt"></i> ${session.ip_address} •
                                    <i class="bi bi-display"></i> ${session.device_type}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            });
    }

    // Load top URLs
    function loadTopURLs() {
        fetch('/api/top-urls/?limit=10')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('urls-container');
                if (data.urls.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="2">
                                <div class="empty-state">
                                    <p>No URL data available</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    container.innerHTML = data.urls.map(url => `
                        <tr>
                            <td>${url.url}</td>
                            <td style="text-align: right;">
                                <strong>${url.visits.toLocaleString()}</strong>
                            </td>
                        </tr>
                    `).join('');
                }
            });
    }

    // Resolve threat
    function resolveThreat(threatId) {
        if (!confirm('Mark this threat as resolved?')) return;
        
        const notes = prompt('Resolution notes (optional):');
        
        fetch(`/security/resolve-threat/${threatId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                notes: notes || ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Threat resolved successfully');
                loadSecurityThreats();
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    // Investigate activity
    function investigateActivity(activityId) {
        if (!confirm('Mark this activity as investigated?')) return;
        
        const isFalsePositive = confirm('Is this a false positive?');
        const notes = prompt('Investigation notes:');
        const action = prompt('Action taken:');
        
        fetch(`/security/investigate-activity/${activityId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                false_positive: isFalsePositive,
                notes: notes || '',
                action_taken: action || ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Activity investigated successfully');
                loadSuspiciousActivities();
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}