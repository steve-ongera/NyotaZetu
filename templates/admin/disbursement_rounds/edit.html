{% extends 'admin_base.html' %}
{% load humanize %}

{% block title %}{% if round %}Edit{% else %}Create{% endif %} Disbursement Round{% endblock %}

{% block extra_css %}
<style>
    .section-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
        border: 1px solid #E2E8F0;
    }

    .page-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #F1F5F9;
    }

    .page-title {
        font-size: 22px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
    }

    .form-section {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: #1E293B;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .required {
        color: #e74c3c;
    }

    .form-control {
        padding: 12px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-control:disabled {
        background: #F8FAFC;
        color: #64748B;
        cursor: not-allowed;
    }

    .form-select {
        padding: 12px;
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        cursor: pointer;
    }

    .form-select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

    .form-check-input {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .form-check-label {
        font-size: 14px;
        color: #1E293B;
        cursor: pointer;
    }

    .help-text {
        font-size: 12px;
        color: #64748B;
        margin-top: 4px;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-info {
        background: #E0F2FE;
        color: #075985;
        border-left: 4px solid #3498db;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        padding-top: 24px;
        border-top: 1px solid #F1F5F9;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: white;
        color: #64748B;
        border: 1px solid #E2E8F0;
    }

    .btn-secondary:hover {
        background: #F8FAFC;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" style="margin-bottom: 20px;">
        <ol class="breadcrumb" style="padding: 0; list-style: none; display: flex; gap: 8px; font-size: 14px;">
            <li style="color: #64748B;">
                <a href="{% url 'admin_dashboard' %}" style="color: #3498db; text-decoration: none;">
                    <i class="bi bi-house-door"></i> Dashboard
                </a>
            </li>
            <li style="color: #94A3B8;">/</li>
            <li style="color: #64748B;">
                <a href="{% url 'disbursement_round_list' %}" style="color: #3498db; text-decoration: none;">
                    Disbursement Rounds
                </a>
            </li>
            <li style="color: #94A3B8;">/</li>
            <li style="color: #1E293B; font-weight: 500;">
                {% if round %}Edit{% else %}Create{% endif %}
            </li>
        </ol>
    </nav>

    <div class="section-container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-{% if round %}pencil{% else %}plus-circle{% endif %}"></i>
                {% if round %}Edit{% else %}Create New{% endif %} Disbursement Round
            </h1>
            <p style="color: #64748B; margin: 0;">
                {% if round %}
                    Update the details for {{ round.name }}
                {% else %}
                    Set up a new disbursement round for accepting and processing bursary applications
                {% endif %}
            </p>
        </div>

        <div class="alert alert-info">
            <i class="bi bi-info-circle" style="font-size: 20px;"></i>
            <div>
                <strong>Important:</strong> Ensure all dates are set correctly. Applications can only be submitted during the application period, and the round must be marked as "Open" for applicants to access it.
            </div>
        </div>

        <form method="post" id="roundForm">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-info-circle"></i>
                    Basic Information
                </h3>

                <div class="form-grid">
                    {% if not round %}
                    <div class="form-group">
                        <label class="form-label" for="fiscal_year">
                            Fiscal Year <span class="required">*</span>
                        </label>
                        <select class="form-select" id="fiscal_year" name="fiscal_year" required>
                            <option value="">Select Fiscal Year</option>
                            {% for fy in fiscal_years %}
                            <option value="{{ fy.id }}">{{ fy.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="help-text">Select the fiscal year for this disbursement round</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="round_number">
                            Round Number <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="round_number" 
                            name="round_number"
                            min="1"
                            max="10"
                            required
                            placeholder="e.g., 1, 2, 3"
                        >
                        <small class="help-text">The sequence number for this round (1, 2, 3, etc.)</small>
                    </div>
                    {% else %}
                    <div class="form-group">
                        <label class="form-label">Fiscal Year</label>
                        <input type="text" class="form-control" value="{{ round.fiscal_year.name }}" disabled>
                        <small class="help-text">Fiscal year cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Round Number</label>
                        <input type="text" class="form-control" value="{{ round.round_number }}" disabled>
                        <small class="help-text">Round number cannot be changed</small>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label" for="name">
                        Round Name <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="name" 
                        name="name"
                        value="{% if round %}{{ round.name }}{% endif %}"
                        required
                        placeholder="e.g., First Tranche 2024, Term 1 Disbursement"
                    >
                    <small class="help-text">A descriptive name for this disbursement round</small>
                </div>
            </div>

            <!-- Dates Configuration -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-calendar-range"></i>
                    Dates Configuration
                </h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="application_start_date">
                            Application Start Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="application_start_date" 
                            name="application_start_date"
                            value="{% if round %}{{ round.application_start_date|date:'Y-m-d' }}{% endif %}"
                            required
                        >
                        <small class="help-text">When applications open</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="application_end_date">
                            Application End Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="application_end_date" 
                            name="application_end_date"
                            value="{% if round %}{{ round.application_end_date|date:'Y-m-d' }}{% endif %}"
                            required
                        >
                        <small class="help-text">Application deadline</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="review_deadline">
                            Review Deadline <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="review_deadline" 
                            name="review_deadline"
                            value="{% if round %}{{ round.review_deadline|date:'Y-m-d' }}{% endif %}"
                            required
                        >
                        <small class="help-text">Deadline for completing reviews</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="disbursement_date">
                            Disbursement Date <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="disbursement_date" 
                            name="disbursement_date"
                            value="{% if round %}{{ round.disbursement_date|date:'Y-m-d' }}{% endif %}"
                            required
                        >
                        <small class="help-text">Expected date for fund disbursement</small>
                    </div>
                </div>
            </div>

            <!-- Budget Allocation -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-currency-dollar"></i>
                    Budget Allocation
                </h3>

                <div class="form-group" style="max-width: 400px;">
                    <label class="form-label" for="allocated_amount">
                        Allocated Amount (KES) <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        class="form-control" 
                        id="allocated_amount" 
                        name="allocated_amount"
                        value="{% if round %}{{ round.allocated_amount }}{% endif %}"
                        step="0.01"
                        min="0"
                        required
                        placeholder="0.00"
                    >
                    <small class="help-text">Total budget allocated for this disbursement round</small>
                </div>
            </div>

            <!-- Status Settings -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-toggle-on"></i>
                    Status Settings
                </h3>

                <div class="form-check">
                    <input 
                        type="checkbox" 
                        class="form-check-input" 
                        id="is_open" 
                        name="is_open"
                        {% if round.is_open or not round %}checked{% endif %}
                    >
                    <label class="form-check-label" for="is_open">
                        <strong>Open for Applications</strong>
                        <div class="help-text" style="margin-top: 4px;">
                            When checked, applicants can submit applications during the application period
                        </div>
                    </label>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i>
                    {% if round %}Update Round{% else %}Create Round{% endif %}
                </button>
                <a href="{% if round %}{% url 'disbursement_round_detail' round.id %}{% else %}{% url 'disbursement_round_list' %}{% endif %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('roundForm');
        const startDate = document.getElementById('application_start_date');
        const endDate = document.getElementById('application_end_date');
        const reviewDate = document.getElementById('review_deadline');
        const disbursementDate = document.getElementById('disbursement_date');

        // Validate date sequence
        form.addEventListener('submit', function(e) {
            const start = new Date(startDate.value);
            const end = new Date(endDate.value);
            const review = new Date(reviewDate.value);
            const disbursement = new Date(disbursementDate.value);

            if (end <= start) {
                e.preventDefault();
                alert('Application end date must be after start date');
                return false;
            }

            if (review <= end) {
                e.preventDefault();
                alert('Review deadline must be after application end date');
                return false;
            }

            if (disbursement <= review) {
                e.preventDefault();
                alert('Disbursement date must be after review deadline');
                return false;
            }

            return true;
        });

        // Auto-format amount input
        const amountInput = document.getElementById('allocated_amount');
        amountInput.addEventListener('blur', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });
</script>
{% endblock %}