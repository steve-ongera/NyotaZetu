{% extends 'base.html' %}
{% load static %}

{% block title %}Create Application - Bursary System{% endblock %}

{% block extra_css %}
<style>
    .form-wizard {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 30px;
        margin: 20px 0;
    }
    
    .wizard-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .wizard-title {
        font-size: 24px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
    }
    
    .wizard-subtitle {
        color: #64748b;
        font-size: 14px;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        position: relative;
    }
    
    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e2e8f0;
        z-index: 0;
    }
    
    .wizard-step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e2e8f0;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #94a3b8;
        transition: all 0.3s;
    }
    
    .wizard-step.active .step-circle {
        background: #3498db;
        border-color: #3498db;
        color: white;
    }
    
    .wizard-step.completed .step-circle {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }
    
    .step-label {
        font-size: 13px;
        color: #64748b;
        font-weight: 500;
    }
    
    .wizard-step.active .step-label {
        color: #3498db;
    }
    
    .wizard-content {
        min-height: 400px;
    }
    
    .step-section {
        display: none;
    }
    
    .step-section.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-section {
        background: #f8fafc;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .form-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .search-box {
        position: relative;
        margin-bottom: 20px;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
    }
    
    .search-result-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .search-result-item:hover {
        background: #f8fafc;
    }
    
    .search-result-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .search-result-info {
        font-size: 13px;
        color: #64748b;
    }
    
    .info-card {
        background: #eff6ff;
        border-left: 4px solid #3498db;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .warning-card {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .success-card {
        background: #d1fae5;
        border-left: 4px solid #10b981;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .error-card {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        padding: 12px 16px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .dynamic-list {
        margin-top: 15px;
    }
    
    .dynamic-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
    }
    
    .remove-item-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #ef4444;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
    }
    
    .btn-group-wizard {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }
    
    .file-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 10px;
    }
    
    .file-upload-area:hover {
        border-color: #3498db;
        background: #f8fafc;
    }
    
    .file-upload-area.has-file {
        border-color: #10b981;
        background: #d1fae5;
    }
    
    .file-name {
        font-size: 13px;
        color: #10b981;
        margin-top: 8px;
        font-weight: 500;
    }
    
    .required-star {
        color: #ef4444;
        margin-left: 3px;
    }
    
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Modal Styles */
    .modal-backdrop.show {
        opacity: 0.5;
    }
    
    .modal-content {
        border-radius: 12px;
        border: none;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        border-bottom: none;
    }
    
    .modal-title {
        font-weight: 600;
    }
    
    .btn-close {
        filter: brightness(0) invert(1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-wizard">
                <!-- Header -->
                <div class="wizard-header">
                    <h1 class="wizard-title">
                        <i class="bi bi-file-earmark-plus me-2"></i>
                        Create New Application
                    </h1>
                    <p class="wizard-subtitle">Fill in the student details and submit bursary application</p>
                </div>
                
                <!-- Wizard Steps -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Student Info</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Guardians</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Application</div>
                    </div>
                    <div class="wizard-step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Documents</div>
                    </div>
                    <div class="wizard-step" data-step="5">
                        <div class="step-circle">5</div>
                        <div class="step-label">Review</div>
                    </div>
                </div>
                
                <!-- Wizard Content -->
                <form id="applicationForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="selectedUserId">
                    
                    <!-- Step 1: Student Search & Basic Info -->
                    <div class="step-section active" data-step="1">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-search"></i>
                                Search Student
                            </h3>
                            
                            <div class="search-box">
                                <label class="form-label">Search by Name, Email, Username, or ID Number</label>
                                <input type="text" class="form-control form-control-lg" id="studentSearch" 
                                       placeholder="Type at least 3 characters to search...">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                            
                            <div id="existingApplicationWarning" style="display: none;"></div>
                        </div>
                        
                        <div class="form-section" id="studentInfoSection" style="display: none;">
                            <h3 class="form-section-title">
                                <i class="bi bi-person"></i>
                                Student Information
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">First Name <span class="required-star">*</span></label>
                                    <input type="text" class="form-control" id="firstName" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Name <span class="required-star">*</span></label>
                                    <input type="text" class="form-control" id="lastName" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email <span class="required-star">*</span></label>
                                    <input type="email" class="form-control" id="email" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone Number <span class="required-star">*</span></label>
                                    <input type="text" class="form-control" id="phoneNumber" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ID Number <span class="required-star">*</span></label>
                                    <input type="text" class="form-control" name="id_number" id="idNumber" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gender <span class="required-star">*</span></label>
                                    <select class="form-select" name="gender" id="gender" required>
                                        <option value="">Select Gender</option>
                                        {% for value, label in gender_choices %}
                                        <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date of Birth <span class="required-star">*</span></label>
                                    <input type="date" class="form-control" name="date_of_birth" id="dateOfBirth" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section" id="locationSection" style="display: none;">
                            <h3 class="form-section-title">
                                <i class="bi bi-geo-alt"></i>
                                Location Information
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ward <span class="required-star">*</span></label>
                                    <select class="form-select" name="ward_id" id="ward" required>
                                        <option value="">Select Ward</option>
                                        {% for ward in wards %}
                                        <option value="{{ ward.id }}">{{ ward.name }} - {{ ward.constituency.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Location</label>
                                    <select class="form-select" name="location_id" id="location">
                                        <option value="">Select Location</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Sub-location</label>
                                    <select class="form-select" name="sublocation_id" id="sublocation">
                                        <option value="">Select Sub-location</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Village</label>
                                    <select class="form-select" name="village_id" id="village">
                                        <option value="">Select Village</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Physical Address <span class="required-star">*</span></label>
                                    <textarea class="form-control" name="physical_address" id="physicalAddress" rows="2" required></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Postal Address</label>
                                    <input type="text" class="form-control" name="postal_address" id="postalAddress">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Guardians & Siblings -->
                    <div class="step-section" data-step="2">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-people"></i>
                                Guardian/Parent Information
                            </h3>
                            
                            <div id="guardiansList" class="dynamic-list"></div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addGuardianBtn">
                                <i class="bi bi-plus-circle me-1"></i> Add Guardian
                            </button>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-person-lines-fill"></i>
                                Siblings Information
                            </h3>
                            
                            <div id="siblingsList" class="dynamic-list"></div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addSiblingBtn">
                                <i class="bi bi-plus-circle me-1"></i> Add Sibling
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Application Details -->
                    <div class="step-section" data-step="3">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-calendar-check"></i>
                                Academic Year & Category
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fiscal Year <span class="required-star">*</span></label>
                                    <select class="form-select" name="fiscal_year_id" id="fiscalYear" required>
                                        <option value="">Select Fiscal Year</option>
                                        {% for fy in fiscal_years %}
                                        <option value="{{ fy.id }}">{{ fy.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bursary Category <span class="required-star">*</span></label>
                                    <select class="form-select" name="bursary_category_id" id="bursaryCategory" required>
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-building"></i>
                                Institution Information
                            </h3>
                            
                            <div class="search-box mb-3">
                                <label class="form-label">Search Institution <span class="required-star">*</span></label>
                                <input type="text" class="form-control" id="institutionSearch" 
                                       placeholder="Type institution name...">
                                <div class="search-results" id="institutionResults"></div>
                            </div>
                            
                            <input type="hidden" name="institution_id" id="selectedInstitutionId">
                            <div id="selectedInstitutionInfo" style="display: none;" class="info-card">
                                <strong id="selectedInstitutionName"></strong><br>
                                <small id="selectedInstitutionDetails"></small>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Admission Number <span class="required-star">*</span></label>
                                    <input type="text" class="form-control" name="admission_number" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Year of Study <span class="required-star">*</span></label>
                                    <input type="number" class="form-control" name="year_of_study" min="1" max="7" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Course Name</label>
                                    <input type="text" class="form-control" name="course_name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Expected Completion Date</label>
                                    <input type="date" class="form-control" name="expected_completion_date">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-cash-stack"></i>
                                Financial Information
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Total Fees Payable <span class="required-star">*</span></label>
                                    <input type="number" class="form-control" name="total_fees_payable" 
                                           id="totalFees" step="0.01" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Fees Paid <span class="required-star">*</span></label>
                                    <input type="number" class="form-control" name="fees_paid" 
                                           id="feesPaid" step="0.01" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Fees Balance</label>
                                    <input type="number" class="form-control" name="fees_balance" 
                                           id="feesBalance" step="0.01" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Amount Requested <span class="required-star">*</span></label>
                                    <input type="number" class="form-control" name="amount_requested" 
                                           step="0.01" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Household Monthly Income</label>
                                    <input type="number" class="form-control" name="household_income" 
                                           step="0.01">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="other_bursaries" 
                                           id="otherBursaries" value="true">
                                    <label class="form-check-label" for="otherBursaries">
                                        Has received other bursaries
                                    </label>
                                </div>
                            </div>
                            
                            <div id="otherBursariesSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Other Bursaries Amount</label>
                                        <input type="number" class="form-control" name="other_bursaries_amount" 
                                               step="0.01">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Source of Other Bursaries</label>
                                        <input type="text" class="form-control" name="other_bursaries_source">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-heart-pulse"></i>
                                Special Circumstances
                            </h3>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="is_orphan" 
                                               id="isOrphan" value="true">
                                        <label class="form-check-label" for="isOrphan">
                                            Orphan (Single Parent)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="is_total_orphan" 
                                               id="isTotalOrphan" value="true">
                                        <label class="form-check-label" for="isTotalOrphan">
                                            Total Orphan
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="is_disabled" 
                                               id="isDisabled" value="true">
                                        <label class="form-check-label" for="isDisabled">
                                            Has Disability
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="has_chronic_illness" 
                                               id="hasChronicIllness" value="true">
                                        <label class="form-check-label" for="hasChronicIllness">
                                            Chronic Illness
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="chronicIllnessSection" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Describe Chronic Illness</label>
                                    <textarea class="form-control" name="chronic_illness_description" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Documents -->
                    <div class="step-section" data-step="4">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-file-earmark-arrow-up"></i>
                                Required Documents
                            </h3>
                            
                            <div class="info-card mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Important:</strong> All documents should be clear, legible scans or photos. 
                                Accepted formats: PDF, JPG, PNG (Max 5MB each)
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Fee Structure <span class="required-star">*</span>
                                    </label>
                                    <div class="file-upload-area" data-target="fee_structure">
                                        <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                        <p class="mb-0 mt-2">Click to upload or drag and drop</p>
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="file-name"></div>
                                    </div>
                                    <input type="file" name="fee_structure" id="fee_structure" 
                                           accept=".pdf,.jpg,.jpeg,.png" style="display: none;" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Admission Letter <span class="required-star">*</span>
                                    </label>
                                    <div class="file-upload-area" data-target="admission_letter">
                                        <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                        <p class="mb-0 mt-2">Click to upload or drag and drop</p>
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="file-name"></div>
                                    </div>
                                    <input type="file" name="admission_letter" id="admission_letter" 
                                           accept=".pdf,.jpg,.jpeg,.png" style="display: none;" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Fee Statement/Balance <span class="required-star">*</span>
                                    </label>
                                    <div class="file-upload-area" data-target="fee_statement">
                                        <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                        <p class="mb-0 mt-2">Click to upload or drag and drop</p>
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="file-name"></div>
                                    </div>
                                    <input type="file" name="fee_statement" id="fee_statement" 
                                           accept=".pdf,.jpg,.jpeg,.png" style="display: none;" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Parent/Guardian ID <span class="required-star">*</span>
                                    </label>
                                    <div class="file-upload-area" data-target="parent_id">
                                        <i class="bi bi-cloud-upload fs-3 text-muted"></i>
                                        <p class="mb-0 mt-2">Click to upload or drag and drop</p>
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="file-name"></div>
                                    </div>
                                    <input type="file" name="parent_id" id="parent_id" 
                                           accept=".pdf,.jpg,.jpeg,.png" style="display: none;" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 5: Review & Submit -->
                    <div class="step-section" data-step="5">
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="bi bi-check-circle"></i>
                                Review Application
                            </h3>
                            
                            <div class="info-card mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                Please review all information before submitting. Once submitted, 
                                an email notification will be sent to the student.
                            </div>
                            
                            <div id="reviewContent"></div>
                        </div>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="btn-group-wizard">
                        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                            <i class="bi bi-arrow-left me-1"></i> Previous
                        </button>
                        <div></div>
                        <button type="button" class="btn btn-primary" id="nextBtn">
                            Next <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                            <i class="bi bi-check-circle me-1"></i> Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="bi bi-check-circle me-2"></i>
                    Application Submitted Successfully
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 64px;"></i>
                <h4 class="mt-3 mb-2">Success!</h4>
                <p class="text-muted mb-3">The application has been submitted successfully.</p>
                <div class="alert alert-info">
                    <strong>Application Number:</strong>
                    <div class="fs-5 mt-2" id="modalApplicationNumber"></div>
                </div>
                <p class="small text-muted">
                    <i class="bi bi-envelope me-1"></i>
                    A confirmation email has been sent to the student.
                </p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                    <i class="bi bi-plus-circle me-1"></i> Create Another Application
                </button>
                <a href="{% url 'student_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-house me-1"></i> Go to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing Application...</h5>
                <p class="text-muted mb-0">Please wait while we submit your application</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 5;
    let guardianCount = 0;
    let siblingCount = 0;
    let selectedUser = null;
    
    // CSRF Token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Step Navigation
    function showStep(step) {
        document.querySelectorAll('.step-section').forEach(section => {
            section.classList.remove('active');
        });
        
        document.querySelector(`.step-section[data-step="${step}"]`).classList.add('active');
        
        document.querySelectorAll('.wizard-step').forEach(stepEl => {
            const stepNum = parseInt(stepEl.dataset.step);
            stepEl.classList.remove('active', 'completed');
            
            if (stepNum === step) {
                stepEl.classList.add('active');
            } else if (stepNum < step) {
                stepEl.classList.add('completed');
            }
        });
        
        // Update buttons
        document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'block';
        document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'block';
        document.getElementById('submitBtn').style.display = step === totalSteps ? 'block' : 'none';
        
        // Generate review content if on last step
        if (step === totalSteps) {
            generateReviewContent();
        }
    }
    
    document.getElementById('nextBtn').addEventListener('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            showStep(currentStep);
        }
    });
    
    document.getElementById('prevBtn').addEventListener('click', function() {
        currentStep--;
        showStep(currentStep);
    });
    
    // Student Search
    let searchTimeout;
    document.getElementById('studentSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 3) {
            document.getElementById('searchResults').style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchStudent(query);
        }, 500);
    });
    
    function searchStudent(query) {
        fetch('{% url "search_student_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                showError(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to search students');
        });
    }
    
    function displaySearchResults(results) {
        const resultsDiv = document.getElementById('searchResults');
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="search-result-item text-center text-muted">No students found</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        resultsDiv.innerHTML = results.map(user => `
            <div class="search-result-item" data-user='${JSON.stringify(user)}'>
                <div class="search-result-name">${user.full_name}</div>
                <div class="search-result-info">
                    <i class="bi bi-envelope me-2"></i>${user.email} &nbsp;
                    <i class="bi bi-telephone me-2"></i>${user.phone_number} &nbsp;
                    <i class="bi bi-card-text me-2"></i>${user.id_number || 'No ID'}
                </div>
            </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        // Add click handlers
        resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const userData = JSON.parse(this.dataset.user);
                selectStudent(userData);
            });
        });
    }
    
    function selectStudent(user) {
        selectedUser = user;
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('studentSearch').value = user.full_name;
        document.getElementById('selectedUserId').value = user.id;
        
        // Fill in basic info
        document.getElementById('firstName').value = user.full_name.split(' ')[0];
        document.getElementById('lastName').value = user.full_name.split(' ').slice(1).join(' ');
        document.getElementById('email').value = user.email;
        document.getElementById('phoneNumber').value = user.phone_number;
        document.getElementById('idNumber').value = user.id_number || '';
        
        // Show student info section
        document.getElementById('studentInfoSection').style.display = 'block';
        document.getElementById('locationSection').style.display = 'block';
        
        // If user has profile, populate data
        if (user.has_profile && user.profile) {
            document.getElementById('gender').value = user.profile.gender || '';
            document.getElementById('dateOfBirth').value = user.profile.date_of_birth || '';
            document.getElementById('ward').value = user.profile.ward_id || '';
            document.getElementById('physicalAddress').value = user.profile.physical_address || '';
            document.getElementById('postalAddress').value = user.profile.postal_address || '';
            
            // Load locations if ward is selected
            if (user.profile.ward_id) {
                loadLocations(user.profile.ward_id, user.profile.location_id);
            }
            
            // Populate guardians
            if (user.guardians && user.guardians.length > 0) {
                user.guardians.forEach(guardian => {
                    addGuardian(guardian);
                });
            }
            
            // Populate siblings
            if (user.siblings && user.siblings.length > 0) {
                user.siblings.forEach(sibling => {
                    addSibling(sibling);
                });
            }
        }
        
        // Check for existing application
        const fiscalYearSelect = document.getElementById('fiscalYear');
        if (fiscalYearSelect.value) {
            checkExistingApplication(user.id, fiscalYearSelect.value);
        }
    }
    
    // Check existing application
    document.getElementById('fiscalYear').addEventListener('change', function() {
        const userId = document.getElementById('selectedUserId').value;
        if (userId) {
            checkExistingApplication(userId, this.value);
        }
        
        // Load bursary categories
        loadBursaryCategories(this.value);
    });
    
    function checkExistingApplication(userId, fiscalYearId) {
        fetch('{% url "check_existing_application_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ 
                user_id: userId,
                fiscal_year_id: fiscalYearId 
            })
        })
        .then(response => response.json())
        .then(data => {
            const warningDiv = document.getElementById('existingApplicationWarning');
            
            if (data.success && data.has_application) {
                warningDiv.innerHTML = `
                    <div class="warning-card">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This student already has an application for this fiscal year.<br>
                        <small>
                            Application #: ${data.application.application_number} | 
                            Status: ${data.application.status} | 
                            Date: ${data.application.date_submitted}
                        </small>
                    </div>
                `;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Load bursary categories
    function loadBursaryCategories(fiscalYearId) {
        fetch('{% url "get_bursary_categories_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ fiscal_year_id: fiscalYearId })
        })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('bursaryCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            
            if (data.success) {
                data.categories.forEach(cat => {
                    select.innerHTML += `
                        <option value="${cat.id}" data-max="${cat.max_amount}" data-min="${cat.min_amount}">
                            ${cat.name} (${cat.category_type}) - Min: KES ${cat.min_amount} | Max: KES ${cat.max_amount}
                        </option>
                    `;
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Location cascading dropdowns
    document.getElementById('ward').addEventListener('change', function() {
        loadLocations(this.value);
    });
    
    function loadLocations(wardId, selectedLocationId = null) {
        fetch('{% url "get_locations_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ ward_id: wardId })
        })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('location');
            select.innerHTML = '<option value="">Select Location</option>';
            
            if (data.success) {
                data.locations.forEach(loc => {
                    select.innerHTML += `<option value="${loc.id}" ${loc.id == selectedLocationId ? 'selected' : ''}>${loc.name}</option>`;
                });
            }
            
            // Clear dependent dropdowns
            document.getElementById('sublocation').innerHTML = '<option value="">Select Sub-location</option>';
            document.getElementById('village').innerHTML = '<option value="">Select Village</option>';
        })
        .catch(error => console.error('Error:', error));
    }
    
    document.getElementById('location').addEventListener('change', function() {
        loadSublocations(this.value);
    });
    
    function loadSublocations(locationId, selectedSublocationId = null) {
        fetch('{% url "get_sublocations_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ location_id: locationId })
        })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('sublocation');
            select.innerHTML = '<option value="">Select Sub-location</option>';
            
            if (data.success) {
                data.sublocations.forEach(sub => {
                    select.innerHTML += `<option value="${sub.id}" ${sub.id == selectedSublocationId ? 'selected' : ''}>${sub.name}</option>`;
                });
            }
            
            document.getElementById('village').innerHTML = '<option value="">Select Village</option>';
        })
        .catch(error => console.error('Error:', error));
    }
    
    document.getElementById('sublocation').addEventListener('change', function() {
        loadVillages(this.value);
    });
    
    function loadVillages(sublocationId) {
        fetch('{% url "get_villages_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ sublocation_id: sublocationId })
        })
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('village');
            select.innerHTML = '<option value="">Select Village</option>';
            
            if (data.success) {
                data.villages.forEach(vil => {
                    select.innerHTML += `<option value="${vil.id}">${vil.name}</option>`;
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Guardian Management
    document.getElementById('addGuardianBtn').addEventListener('click', function() {
        addGuardian();
    });
    
    function addGuardian(data = null) {
        const guardianHtml = `
            <div class="dynamic-item" data-index="${guardianCount}">
                <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">
                    <i class="bi bi-x-circle"></i>
                </button>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Name <span class="required-star">*</span></label>
                        <input type="text" class="form-control" name="guardian_name_${guardianCount}" 
                               value="${data ? data.name : ''}" required>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Relationship <span class="required-star">*</span></label>
                        <select class="form-select" name="guardian_relationship_${guardianCount}" required>
                            <option value="">Select</option>
                            {% for value, label in relationship_choices %}
                            <option value="{{ value }}" ${data && data.relationship === '{{ value }}' ? 'selected' : ''}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Phone Number</label>
                        <input type="text" class="form-control" name="guardian_phone_${guardianCount}" 
                               value="${data ? data.phone_number : ''}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="guardian_email_${guardianCount}" 
                               value="${data ? data.email : ''}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">ID Number</label>
                        <input type="text" class="form-control" name="guardian_id_${guardianCount}" 
                               value="${data ? data.id_number : ''}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Employment Status</label>
                        <select class="form-select" name="guardian_employment_${guardianCount}">
                            {% for value, label in employment_status %}
                            <option value="{{ value }}" ${data && data.employment_status === '{{ value }}' ? 'selected' : ''}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Occupation</label>
                        <input type="text" class="form-control" name="guardian_occupation_${guardianCount}" 
                               value="${data ? data.occupation : ''}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Monthly Income (KES)</label>
                        <input type="number" class="form-control" name="guardian_income_${guardianCount}" 
                               step="0.01" value="${data ? data.monthly_income : ''}">
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('guardiansList').insertAdjacentHTML('beforeend', guardianHtml);
        guardianCount++;
        
        // Update hidden count field
        updateGuardianCount();
    }
    
    function updateGuardianCount() {
        let count = document.getElementById('guardiansList').querySelectorAll('.dynamic-item').length;
        let countInput = document.querySelector('input[name="guardian_count"]');
        if (!countInput) {
            countInput = document.createElement('input');
            countInput.type = 'hidden';
            countInput.name = 'guardian_count';
            document.getElementById('applicationForm').appendChild(countInput);
        }
        countInput.value = count;
    }
    
    // Sibling Management
    document.getElementById('addSiblingBtn').addEventListener('click', function() {
        addSibling();
    });
    
    function addSibling(data = null) {
        const siblingHtml = `
            <div class="dynamic-item" data-index="${siblingCount}">
                <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">
                    <i class="bi bi-x-circle"></i>
                </button>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Name <span class="required-star">*</span></label>
                        <input type="text" class="form-control" name="sibling_name_${siblingCount}" 
                               value="${data ? data.name : ''}" required>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" name="sibling_age_${siblingCount}" 
                               min="1" max="30" value="${data ? data.age : ''}">
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Education Level</label>
                        <input type="text" class="form-control" name="sibling_education_${siblingCount}" 
                               value="${data ? data.education_level : ''}">
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-control" name="sibling_school_${siblingCount}" 
                               value="${data ? data.school_name : ''}">
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('siblingsList').insertAdjacentHTML('beforeend', siblingHtml);
        siblingCount++;
        
        updateSiblingCount();
    }
    
    function updateSiblingCount() {
        let count = document.getElementById('siblingsList').querySelectorAll('.dynamic-item').length;
        let countInput = document.querySelector('input[name="sibling_count"]');
        if (!countInput) {
            countInput = document.createElement('input');
            countInput.type = 'hidden';
            countInput.name = 'sibling_count';
            document.getElementById('applicationForm').appendChild(countInput);
        }
        countInput.value = count;
    }
    
    // Institution Search
    let institutionTimeout;
    document.getElementById('institutionSearch').addEventListener('input', function(e) {
        clearTimeout(institutionTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            document.getElementById('institutionResults').style.display = 'none';
            return;
        }
        
        institutionTimeout = setTimeout(() => {
            searchInstitution(query);
        }, 500);
    });
    
    function searchInstitution(query) {
        fetch('{% url "search_institution_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayInstitutionResults(data.results);
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    function displayInstitutionResults(results) {
        const resultsDiv = document.getElementById('institutionResults');
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="search-result-item text-center text-muted">No institutions found</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        resultsDiv.innerHTML = results.map(inst => `
            <div class="search-result-item" data-institution='${JSON.stringify(inst)}'>
                <div class="search-result-name">${inst.name}</div>
                <div class="search-result-info">
                    ${inst.institution_type} - ${inst.county}
                </div>
            </div>
        `).join('');
        
        resultsDiv.style.display = 'block';
        
        resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const instData = JSON.parse(this.dataset.institution);
                selectInstitution(instData);
            });
        });
    }
    
    function selectInstitution(institution) {
        document.getElementById('institutionResults').style.display = 'none';
        document.getElementById('institutionSearch').value = institution.name;
        document.getElementById('selectedInstitutionId').value = institution.id;
        
        document.getElementById('selectedInstitutionName').textContent = institution.name;
        document.getElementById('selectedInstitutionDetails').textContent = 
            `${institution.institution_type} | ${institution.county}`;
        document.getElementById('selectedInstitutionInfo').style.display = 'block';
    }
    
    // Calculate fees balance
    document.getElementById('totalFees').addEventListener('input', calculateBalance);
    document.getElementById('feesPaid').addEventListener('input', calculateBalance);
    
    function calculateBalance() {
        const total = parseFloat(document.getElementById('totalFees').value) || 0;
        const paid = parseFloat(document.getElementById('feesPaid').value) || 0;
        document.getElementById('feesBalance').value = (total - paid).toFixed(2);
    }
    
    // Toggle other bursaries section
    document.getElementById('otherBursaries').addEventListener('change', function() {
        document.getElementById('otherBursariesSection').style.display = 
            this.checked ? 'block' : 'none';
    });
    
    // Toggle chronic illness section
    document.getElementById('hasChronicIllness').addEventListener('change', function() {
        document.getElementById('chronicIllnessSection').style.display = 
            this.checked ? 'block' : 'none';
    });
    
    // File Upload Handling
    document.querySelectorAll('.file-upload-area').forEach(area => {
        area.addEventListener('click', function() {
            const targetId = this.dataset.target;
            document.getElementById(targetId).click();
        });
    });
    
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            const area = document.querySelector(`[data-target="${this.id}"]`);
            const fileName = area.querySelector('.file-name');
            
            if (this.files.length > 0) {
                const file = this.files[0];
                fileName.textContent = ` ${file.name}`;
                area.classList.add('has-file');
            } else {
                fileName.textContent = '';
                area.classList.remove('has-file');
            }
        });
    });
    
    // Validation
    function validateStep(step) {
        if (step === 1) {
            if (!document.getElementById('selectedUserId').value) {
                showError('Please select a student');
                return false;
            }
            if (!document.getElementById('gender').value || !document.getElementById('dateOfBirth').value ||
                !document.getElementById('ward').value) {
                showError('Please fill in all required fields');
                return false;
            }
        }
        
        if (step === 3) {
            if (!document.getElementById('fiscalYear').value || !document.getElementById('bursaryCategory').value ||
                !document.getElementById('selectedInstitutionId').value) {
                showError('Please fill in all required application fields');
                return false;
            }
        }
        
        if (step === 4) {
            const requiredDocs = ['fee_structure', 'admission_letter', 'fee_statement', 'parent_id'];
            for (let doc of requiredDocs) {
                if (!document.getElementById(doc).files.length) {
                    showError(`Please upload ${doc.replace('_', ' ')}`);
                    return false;
                }
            }
        }
        
        return true;
    }
    
    // Generate Review Content
    function generateReviewContent() {
        const reviewHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Student Information</h6>
                    <p><strong>Name:</strong> ${document.getElementById('firstName').value} ${document.getElementById('lastName').
                    